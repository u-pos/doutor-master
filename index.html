<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>DBDã‚¹ã‚­ãƒ«ãƒã‚§ãƒƒã‚¯ï¼šæ€’æ¶›ã®åµ é€£ç¶šãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
<style>
  :root{
    --bg:#0f1115; --fg:#eaeef2; --muted:#9aa4af; --accent:#4ade80; --warn:#f59e0b; --danger:#ef4444;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{min-height:100%;display:flex;flex-direction:column;align-items:center;gap:12px;padding:12px}
  .topbar{width:100%;max-width:680px;display:flex;justify-content:space-between;align-items:center;gap:8px}
  .title{font-weight:700;font-size:clamp(16px,2.8vw,22px)}
  .stats{display:flex;gap:10px;font-weight:600}
  .btns{display:flex;gap:8px}
  button{
    border:1px solid #26303a;background:#161a21;color:var(--fg);border-radius:10px;
    padding:10px 12px;font-weight:700;cursor:pointer;touch-action:manipulation
  }
  button:active{transform:translateY(1px)}
  button.primary{background:#1f2937;border-color:#334155}
  button.accent{background:#12331c;border-color:#1f6d39;color:#bbf7d0}
  button.warn{background:#3a2b12;border-color:#8a5a12;color:#fde68a}
  button.danger{background:#3a1515;border-color:#7f1d1d;color:#fecaca}
  .board{width:100%;max-width:680px;aspect-ratio:1/1;position:relative}
  canvas{width:100%;height:100%;display:block;border-radius:16px;background:#0b0e13}
  .hint{font-size:14px;color:var(--muted);text-align:center}
  .footer{margin-top:auto;font-size:12px;color:var(--muted)}
  dialog{
    border:none;border-radius:14px;padding:0;max-width:520px;width:90vw;background:#0f131a;color:var(--fg)
  }
  .dlg-head{padding:14px 16px;border-bottom:1px solid #253040;font-weight:700}
  .dlg-body{padding:12px 16px}
  .rank-list{width:100%;border-collapse:collapse}
  .rank-list th,.rank-list td{padding:8px 6px;border-bottom:1px solid #1d2533;text-align:left}
  .rank-list th{color:#aab4bf;font-weight:600}
  .kbd{display:inline-block;border:1px solid #2a3442;border-bottom-width:2px;border-radius:6px;padding:2px 6px;font-weight:700}
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">DBDã‚¹ã‚­ãƒ«ãƒã‚§ãƒƒã‚¯ï¼šæ€’æ¶›ã®åµ é€£ç¶šãƒãƒ£ãƒ¬ãƒ³ã‚¸</div>
      <div class="btns">
        <button id="startBtn" class="primary">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button id="pauseBtn" class="warn">â¸ ä¸€æ™‚åœæ­¢</button>
        <button id="muteBtn">ğŸ”ˆ ãƒŸãƒ¥ãƒ¼ãƒˆ</button>
        <button id="rankBtn" class="accent">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
      </div>
    </div>

    <div class="topbar" style="margin-top:-6px">
      <div class="stats">
        <div>é€£ç¶šæˆåŠŸ: <span id="streak">0</span></div>
        <div>ãƒ™ã‚¹ãƒˆ: <span id="best">0</span></div>
        <div>é€Ÿåº¦: <span id="speed">1.0x</span></div>
      </div>
      <div class="hint">ã‚¹ãƒšãƒ¼ã‚¹ / ç”»é¢ã‚¿ãƒƒãƒ— ã§åˆ¤å®šã€‚Good/Greatã‚¾ãƒ¼ãƒ³ã¯æœ¬å®¶é¢¨ã®å¹…ã‚„ã§ã€‚</div>
    </div>

    <div class="board">
      <canvas id="cv" width="800" height="800"></canvas>
    </div>

    <div class="footer">â€» æˆåŠŸæ™‚ã« <code>success.mp3</code> ã‚’å†ç”Ÿã€‚iOSå¯¾ç­–ã§æœ€åˆã®ã‚¿ãƒƒãƒ—æ™‚ã«éŸ³ã®æ¨©é™ã‚’è§£æ”¾ã—ã¾ã™ã€‚</div>
  </div>

  <dialog id="rankDlg">
    <div class="dlg-head">ğŸ† ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ TOP5</div>
    <div class="dlg-body">
      <table class="rank-list" id="rankTable">
        <thead><tr><th>#</th><th>åå‰</th><th>é€£ç¶šæˆåŠŸ</th><th>æ—¥æ™‚</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
        <button id="closeRank">é–‰ã˜ã‚‹</button>
        <button id="resetRank" class="danger">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>
  </dialog>

<script>
(() => {
  // ====== èª¿æ•´ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆDBDé¢¨å¹…ã®è¿‘ä¼¼ï¼‰======
  const CONFIG = {
    goodArcRatio: 0.18,   // å††å‘¨ã«å¯¾ã™ã‚‹GoodæˆåŠŸã‚¾ãƒ¼ãƒ³æ¯”ç‡ï¼ˆç´„18%ï¼‰
    greatArcRatio: 0.04,  // Goodå†…ã«å«ã¾ã‚Œã‚‹Greatã‚¾ãƒ¼ãƒ³ï¼ˆç´„4%ï¼‰
    baseRPM: 60,          // åˆæœŸå›è»¢ã‚¹ãƒ”ãƒ¼ãƒ‰ï¼ˆ1åˆ†é–“ã«ä½•å‘¨ï¼‰â†’ã‚²ãƒ¼ãƒ è¡¨ç¤ºã§ã¯xå€ã«æ›ç®—
    rpmIncrease: 6,       // æˆåŠŸã”ã¨ã®RPMå¢—åŠ 
    maxRPM: 180,          // ä¸Šé™
    pointerWidth: 6,      // ãƒã‚¤ãƒ³ã‚¿å¤ªã•ï¼ˆpxï¼‰
    inputCooldownMs: 250, // å…¥åŠ›é€£æ‰“å¯¾ç­–
    nameMaxLen: 12
  };

  // ====== çŠ¶æ…‹ç®¡ç† ======
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');
  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const muteBtn  = document.getElementById('muteBtn');
  const rankBtn  = document.getElementById('rankBtn');
  const rankDlg  = document.getElementById('rankDlg');
  const rankTable= document.querySelector('#rankTable tbody');
  const closeRank= document.getElementById('closeRank');
  const resetRank= document.getElementById('resetRank');

  const elStreak = document.getElementById('streak');
  const elBest   = document.getElementById('best');
  const elSpeed  = document.getElementById('speed');

  let running = false;
  let paused  = false;
  let muted   = false;
  let lastInputAt = 0;

  // å›è»¢ & ã‚¾ãƒ¼ãƒ³
  let angle = 0; // ãƒ©ã‚¸ã‚¢ãƒ³ï¼ˆ0ã¯ä¸Šæ–¹å‘ï¼‰
  let rpm = CONFIG.baseRPM;
  let zoneStart = 0; // ã‚¾ãƒ¼ãƒ³é–‹å§‹è§’ï¼ˆradï¼‰
  let zoneSize  = Math.PI * 2 * CONFIG.goodArcRatio;
  let greatSize = Math.PI * 2 * CONFIG.greatArcRatio;
  let streak = 0;
  let best = loadBest() || 0;

  // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª
  const successAudio = new Audio('success.mp3');
  successAudio.preload = 'auto';
  successAudio.volume = 0.9;

  // iOS/ãƒ¢ãƒã‚¤ãƒ«ã®å†ç”Ÿè§£æ”¾
  function unlockAudio() {
    successAudio.muted = muted;
    // ç„¡éŸ³å†ç”Ÿã§è§£æ”¾ï¼ˆcatchã§æ¡ã‚Šã¤ã¶ã—ï¼‰
    successAudio.play().then(()=>{ successAudio.pause(); successAudio.currentTime = 0; }).catch(()=>{});
    window.removeEventListener('pointerdown', unlockAudio, {once:true});
  }
  window.addEventListener('pointerdown', unlockAudio, {once:true});

  // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ»æç”»
  function draw() {
    const w = cv.width, h = cv.height;
    const CX = w/2, CY = h/2;
    const rOuter = Math.min(w,h)*0.42;
    const rInner = rOuter - 36;

    ctx.clearRect(0,0,w,h);

    // èƒŒæ™¯å††
    ctx.beginPath();
    ctx.arc(CX, CY, rOuter+24, 0, Math.PI*2);
    ctx.fillStyle = '#0a0d12';
    ctx.fill();

    // ãƒªãƒ³ã‚°
    ctx.beginPath();
    ctx.arc(CX, CY, rOuter, 0, Math.PI*2);
    ctx.lineWidth = 24;
    ctx.strokeStyle = '#1a2330';
    ctx.stroke();

    // Goodã‚¾ãƒ¼ãƒ³
    ctx.beginPath();
    ctx.strokeStyle = '#1f9d55'; // ç·‘
    ctx.lineWidth = 24;
    ctx.arc(CX, CY, rOuter, zoneStart, zoneStart+zoneSize);
    ctx.stroke();

    // Greatã‚¾ãƒ¼ãƒ³ï¼ˆGoodã®ä¸­ï¼‰
    const greatStart = zoneStart + (zoneSize - greatSize)/2;
    ctx.beginPath();
    ctx.strokeStyle = '#fbbf24'; // é»„
    ctx.lineWidth = 24;
    ctx.arc(CX, CY, rOuter, greatStart, greatStart+greatSize);
    ctx.stroke();

    // ç›®ç››ã‚Šï¼ˆé£¾ã‚Šï¼‰
    ctx.save();
    ctx.translate(CX, CY);
    const ticks = 32;
    for(let i=0;i<ticks;i++){
      const a = i*(Math.PI*2/ticks);
      const x1 = Math.cos(a)*(rInner-10), y1 = Math.sin(a)*(rInner-10);
      const x2 = Math.cos(a)*(rInner-2),  y2 = Math.sin(a)*(rInner-2);
      ctx.beginPath();
      ctx.moveTo(x1,y1); ctx.lineTo(x2,y2);
      ctx.strokeStyle = '#263146'; ctx.lineWidth = 2; ctx.stroke();
    }
    ctx.restore();

    // ãƒã‚¤ãƒ³ã‚¿
    ctx.save();
    ctx.translate(CX, CY);
    ctx.rotate(angle);
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.lineTo(0, -rInner);
    ctx.lineWidth = CONFIG.pointerWidth;
    ctx.strokeStyle = '#e5e7eb';
    ctx.shadowColor = '#93c5fd';
    ctx.shadowBlur = 8;
    ctx.stroke();
    ctx.restore();

    // ä¸­å¤®ãƒ©ãƒ™ãƒ«
    ctx.fillStyle = '#9aa4af';
    ctx.font = '700 28px system-ui, -apple-system, Segoe UI';
    ctx.textAlign = 'center';
    ctx.fillText(`æ€’æ¶›ã®åµ é€£ç¶š ${streak}`, CX, CY+10);
  }

  function resizeCanvas() {
    // ãƒ‡ãƒã‚¤ã‚¹ãƒ”ã‚¯ã‚»ãƒ«æ¯”å¯¾å¿œ
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const rect = cv.getBoundingClientRect();
    cv.width  = Math.round(rect.width  * dpr);
    cv.height = Math.round(rect.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0); // ã‚¹ã‚±ãƒ¼ãƒ«ã¯æç”»ã§è€ƒæ…®æ¸ˆ
    draw();
  }
  new ResizeObserver(resizeCanvas).observe(cv);

  // ã‚¾ãƒ¼ãƒ³ã®å†é…ç½®
  function randomizeZone() {
    const pad = 0.15; // ä¸Šæ–¹å‘ã™ãã«æ¥ãªã„ã‚ˆã†è»½ã„ã°ã‚‰ã¤ã
    const full = Math.PI*2;
    zoneStart = Math.random() * full;
    // é€£ç¶šã§ä¼¼ãŸä½ç½®ã«ãªã‚Šã‚„ã™ã„ã¨ã—ã‚“ã©ã„ã®ã§å°‘ã—ã‚ªãƒ•ã‚»ãƒƒãƒˆ
    zoneStart = (zoneStart + (Math.random()*pad - pad/2)) % full;
  }

  // é€Ÿåº¦è¡¨ç¤º
  function updateHUD() {
    elStreak.textContent = String(streak);
    elBest.textContent   = String(best);
    const speedX = (rpm / CONFIG.baseRPM).toFixed(1);
    elSpeed.textContent  = `${speedX}x`;
  }

  // ãƒ«ãƒ¼ãƒ—
  let lastTs = 0;
  function loop(ts){
    if(!running){ return; }
    if(paused){
      requestAnimationFrame(loop);
      return;
    }
    if(!lastTs) lastTs = ts;
    const dt = (ts - lastTs)/1000; // ç§’
    lastTs = ts;

    // å›è»¢
    const rps = rpm / 60; // per second
    angle = (angle + rps * Math.PI*2 * dt) % (Math.PI*2);

    draw();
    requestAnimationFrame(loop);
  }

  // å…¥åŠ›å‡¦ç†
  function tryCheck(){
    const now = performance.now();
    if(now - lastInputAt < CONFIG.inputCooldownMs) return;
    lastInputAt = now;

    if(!running) return;

    const a = angleNorm(angle);
    const g0 = angleNorm(zoneStart);
    const g1 = angleNorm(zoneStart + zoneSize);

    const inGood = angleInRange(a, g0, g1);

    if(inGood){
      // æˆåŠŸï¼
      playSuccess();
      streak++;
      best = Math.max(best, streak);
      // é›£æ˜“åº¦ã‚¢ãƒƒãƒ—
      rpm = Math.min(CONFIG.maxRPM, rpm + CONFIG.rpmIncrease);
      randomizeZone();
      updateHUD();
    }else{
      // å¤±æ•— â†’ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
      gameOver();
    }
  }

  function angleNorm(a){
    const two = Math.PI*2;
    return (a % two + two) % two;
  }
  function angleInRange(a, start, end){
    // å††ç’°ãƒ¬ãƒ³ã‚¸åˆ¤å®šï¼ˆstart<=a<=endã€è·¨ãå¯¾å¿œï¼‰
    if(start<=end) return a>=start && a<=end;
    return a>=start || a<=end;
  }

  // ã‚µã‚¦ãƒ³ãƒ‰
  function playSuccess(){
    if(muted) return;
    try{
      successAudio.currentTime = 0;
      successAudio.play().catch(()=>{});
    }catch(_){}
  }

  // ã‚²ãƒ¼ãƒ åˆ¶å¾¡
  function startGame(){
    running = true; paused = false;
    lastTs = 0; angle = 0; rpm = CONFIG.baseRPM; streak = 0;
    randomizeZone();
    updateHUD();
    requestAnimationFrame(loop);
  }
  function pauseGame(){
    paused = !paused;
    pauseBtn.textContent = paused ? 'â–¶ å†é–‹' : 'â¸ ä¸€æ™‚åœæ­¢';
  }
  function stopGame(){
    running = false; paused = false; lastTs = 0;
  }

  function gameOver(){
    stopGame();
    updateHUD();
    // åå‰å…¥åŠ›ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯ï¼‰
    const name = (prompt('å¤±æ•—ï¼è¨˜éŒ²ã‚’ç™»éŒ²ã™ã‚‹ã§ï¼Ÿ\nåå‰ï¼ˆä»»æ„ãƒ»'+CONFIG.nameMaxLen+'æ–‡å­—ã¾ã§ï¼‰','')||'').trim().slice(0, CONFIG.nameMaxLen);
    if(streak>0){
      saveScore({name: name||'åç„¡ã—ã•ã‚“', score: streak, at: Date.now()});
      renderRanking();
    }
  }

  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
  const KEY = 'skillcheck_top5';
  function loadScores(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr)? arr : [];
    }catch{return []}
  }
  function saveScore(entry){
    const arr = loadScores();
    arr.push(entry);
    arr.sort((a,b)=> b.score - a.score || b.at - a.at);
    const top5 = arr.slice(0,5);
    localStorage.setItem(KEY, JSON.stringify(top5));
    // ãƒ™ã‚¹ãƒˆæ›´æ–°
    best = Math.max(best, top5[0]?.score||0);
    updateHUD();
  }
  function loadBest(){
    const arr = loadScores();
    return arr[0]?.score||0;
  }
  function renderRanking(){
    const arr = loadScores();
    rankTable.innerHTML = '';
    arr.forEach((e,i)=>{
      const tr = document.createElement('tr');
      const dt = new Date(e.at);
      const dstr = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
      tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(e.name)}</td><td>${e.score}</td><td>${dstr}</td>`;
      rankTable.appendChild(tr);
    });
  }
  function resetRanking(){
    localStorage.removeItem(KEY);
    renderRanking();
    best = 0; updateHUD();
  }
  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆ
  startBtn.addEventListener('click', ()=>{ startGame(); });
  pauseBtn.addEventListener('click', ()=>{ if(running) pauseGame(); });
  muteBtn.addEventListener('click', ()=>{
    muted = !muted;
    successAudio.muted = muted;
    muteBtn.textContent = muted ? 'ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆä¸­' : 'ğŸ”ˆ ãƒŸãƒ¥ãƒ¼ãƒˆ';
  });
  rankBtn.addEventListener('click', ()=>{ renderRanking(); rankDlg.showModal(); });
  closeRank.addEventListener('click', ()=> rankDlg.close());
  resetRank.addEventListener('click', ()=>{
    if(confirm('ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã§ï¼Ÿ')) resetRanking();
  });

  // å…¥åŠ›ï¼ˆã‚¹ãƒšãƒ¼ã‚¹/ã‚¿ãƒƒãƒ—ï¼‰
  window.addEventListener('keydown', (e)=>{
    if(e.code==='Space'){ e.preventDefault(); tryCheck(); }
  });
  cv.addEventListener('pointerdown', ()=>{ tryCheck(); });

  // åˆæœŸ
  renderRanking();
  updateHUD();
  resizeCanvas();
})();
</script>
</body>
</html>
