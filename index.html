<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>スキルチェックゲーム</title>
<style>
  :root{ --bg:#0f1115; --fg:#eaeef2; }
  html,body{
    margin:0;height:100%;
    background:var(--bg);color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    overscroll-behavior:none;touch-action:none;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;
  }
  header.title{width:100%;display:flex;justify-content:center;align-items:center;
    padding:8px 6px;margin:0;background:#0b1220;border-bottom:1px solid #1f2b3a}
  header.title h1{margin:0;font-size:clamp(18px,4.3vw,24px);font-weight:900;color:#9bd5ff}

  .wrap{min-height:calc(100dvh - 48px);display:flex;flex-direction:column;align-items:center;gap:4px;padding:4px 6px 2px}
　.welcome {
  /* 既存の指定に追加 */
  transform: translateY(20px);
}
  .board{width:100%;max-width:720px;position:relative}
  #cv{width:100%;height:100%;display:block;background:#0b0e13;border-radius:12px}

  /* 爆発動画オーバーレイ */
  #explosion {
    position:absolute;inset:0;
    width:100%;height:100%;
    object-fit:cover;
    display:none;z-index:10;
    pointer-events:none;
  }

  /* ミュート（円の左上固定） */
  #muteBtn{
    position:absolute;top:6px;left:6px;z-index:5;
    width:40px;height:40px;font-size:20px;line-height:1;text-align:center;
    border-radius:8px;border:1px solid #26303a;background:#1f2937;color:#eaeef2;cursor:pointer;
  }

  .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:3;font-weight:900;
    font-size:clamp(26px,7.5vw,52px);background:rgba(0,0,0,.25);backdrop-filter:saturate(120%) blur(1px);text-align:center}
  .overlay.show{display:flex}
  .welcome{position:absolute;inset:0;display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center;z-index:2;
    text-align:center;background:rgba(0,0,0,.25)}
  .welcome h2{margin:0;font-size:clamp(22px,6.6vw,40px);font-weight:900;color:#c8ffe0}

  /* TAPを少し上へ、下に少し余白 */
  .tap-row{width:100%;max-width:820px;margin-top:-10px;display:flex;justify-content:center}
  #tapBtn{
    width:min(92%,620px);height:92px;margin-bottom:10px;
    border:2px solid #334155;border-radius:16px;background:#0f131a;
    font-weight:900;font-size:clamp(20px,6vw,30px);color:#e5e7eb;cursor:pointer;-webkit-tap-highlight-color:transparent;
  }
  #tapBtn[disabled]{opacity:.45;cursor:not-allowed}

  .bar{display:flex;justify-content:center;gap:8px}
  .btn{border:1px solid #26303a;background:#1f2937;color:#fff;border-radius:12px;padding:12px 16px;font-weight:900;cursor:pointer}
  #startBtn{background:#10b981;border-color:#065f46;color:#062e26}

  #persecutionWrap{display:flex;justify-content:center;gap:8px}
  #persecutionBtn{display:none;background:#ef4444;color:#fff;border-radius:12px;padding:12px 16px}
  #rankPerBtn{display:none}

  dialog{border:none;border-radius:12px;padding:0;max-width:520px;width:90vw;background:#0f131a;color:#fff}
  .dlg-head{padding:12px 14px;border-bottom:1px solid #253040;font-weight:700}
  .rank-list{width:100%;border-collapse:collapse}
  .rank-list th,.rank-list td{padding:8px 6px;border-bottom:1px solid #1d2533;text-align:left}
</style>
</head>
<body>
  <header class="title" id="hdr"><h1>スキルチェックゲーム</h1></header>

  <div class="wrap">
    <div class="board" id="board">
      <canvas id="cv"></canvas>
      <video id="explosion" src="ex.mp4"></video>
      <button id="muteBtn" aria-label="ミュート切替">🔊</button>
      <div id="welcome" class="welcome"><h2>目指せ 50連続！</h2></div>
      <div id="overlay" class="overlay"></div>
    </div>

    <div class="tap-row" id="tapRow"><button id="tapBtn" disabled>TAP</button></div>

    <!-- スタート＋ランキング（通常） -->
    <div class="bar" id="btnBar">
      <button id="startBtn" class="btn">▶ スタート</button>
      <button id="rankNormalBtn" class="btn">ランキング（通常）</button>
    </div>

    <!-- 迫害モード＋ランキング（迫害） -->
    <div id="persecutionWrap">
      <button id="persecutionBtn" class="btn">⚠ 迫害モード</button>
      <button id="rankPerBtn" class="btn">ランキング（迫害）</button>
    </div>
  </div>

  <!-- ランキング -->
  <dialog id="rankDlg">
    <div class="dlg-head" id="rankTitle">🏆 自己ランキングTOP5（通常モード）</div>
    <div class="dlg-body">
      <table class="rank-list"><thead><tr><th>#</th><th>日付</th><th>連続回数</th></tr></thead><tbody id="rankTbody"></tbody></table>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin:10px 14px 14px"><button id="closeRank" class="btn">閉じる</button></div>
    </div>
  </dialog>

<script>
(() => {
  const CONFIG = {RPM:60,NORMAL_ZONE:0.10,PERSECUTE_ZONE:0.06,TARGET_STREAK:50};

  const cv=document.getElementById('cv'),ctx=cv.getContext('2d',{alpha:false});
  const startBtn=document.getElementById('startBtn'),perBtn=document.getElementById('persecutionBtn');
  const tapBtn=document.getElementById('tapBtn'),muteBtn=document.getElementById('muteBtn');
  const overlay=document.getElementById('overlay'),welcome=document.getElementById('welcome');
  const explosion=document.getElementById('explosion');
  const rankNormalBtn=document.getElementById('rankNormalBtn'),rankPerBtn=document.getElementById('rankPerBtn');
  const rankDlg=document.getElementById('rankDlg'),rankTbody=document.getElementById('rankTbody'),rankTitle=document.getElementById('rankTitle'),closeRank=document.getElementById('closeRank');

  let rafId,phase='idle',mode='normal',streak=0,zoneStart=0,angle=0;

  const FULL=Math.PI*2;
  function draw(){
    const w=cv.width=cv.clientWidth,h=cv.height=cv.clientHeight;
    ctx.clearRect(0,0,w,h);
    const r=Math.min(w,h)*0.42;
    // 枠
    ctx.beginPath();ctx.arc(w/2,h/2,r,0,FULL);ctx.strokeStyle="#1a2330";ctx.lineWidth=2;ctx.stroke();
    // ゾーン
    ctx.beginPath();ctx.arc(w/2,h/2,r,zoneStart,zoneStart+FULL*0.1);
    ctx.strokeStyle="#fff";ctx.lineWidth=24;ctx.stroke();
    // 針（爆発時は描かない）
    if(phase!=='explosion'){
      ctx.beginPath();ctx.moveTo(w/2,h/2);ctx.lineTo(w/2+r*1.2*Math.cos(angle),h/2+r*1.2*Math.sin(angle));
      ctx.strokeStyle="#ef4444";ctx.lineWidth=6;ctx.stroke();
    }
    // コンボ
    ctx.font="900 28px system-ui";ctx.fillStyle="#fff";ctx.textAlign="center";
    ctx.fillText(streak,w/2,h/2-40);
  }
  function loop(){draw();rafId=requestAnimationFrame(loop);}

  function startGame(m){mode=m;phase='play';welcome.style.display='none';streak=0;if(rafId)cancelAnimationFrame(rafId);loop();}

  function gameOver(){
    phase='explosion';
    explosion.style.display='block';
    explosion.currentTime=0;
    explosion.play();
    explosion.onended=()=>{ explosion.style.display='none'; phase='idle'; };
  }

  // イベント
  startBtn.onclick=()=>startGame('normal');
  perBtn.onclick=()=>startGame('persecution');
  tapBtn.onclick=()=>{ if(phase==='play'){ /* 仮に失敗 */ gameOver(); } };
  muteBtn.onclick=()=>{};

  rankNormalBtn.onclick=()=>openRanking('normal');
  rankPerBtn.onclick=()=>openRanking('persecution');
  function openRanking(which){
    rankTitle.textContent=(which==='normal')?'🏆 自己ランキングTOP5（通常モード）':'🏆 自己ランキングTOP5（迫害モード）';
    rankDlg.showModal();
  }
  closeRank.onclick=()=>rankDlg.close();

  // 初期
  draw();
})();
</script>
</body>
</html>
