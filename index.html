<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>DBDã‚¹ã‚­ãƒ«ãƒã‚§ãƒƒã‚¯ï¼šæ€’æ¶›ã®åµï¼ˆã‚¹ã‚¤ãƒ¼ãƒ—å‹ãƒ»ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ï¼‰</title>
<style>
  :root{ --bg:#0f1115; --fg:#eaeef2; --muted:#9aa4af; --accent:#4ade80; --warn:#f59e0b; --danger:#ef4444; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{min-height:100%;display:flex;flex-direction:column;align-items:center;gap:10px;padding:12px}
  .topbar{width:100%;max-width:720px;display:flex;justify-content:center;align-items:center}
  .btn{border:1px solid #26303a;background:#161a21;color:var(--fg);border-radius:12px;padding:10px 16px;font-weight:800;cursor:pointer;touch-action:manipulation}
  .btn.primary{background:#1f2937;border-color:#334155}
  .btn.accent{background:#12331c;border-color:#1f6d39;color:#bbf7d0}
  .btn.warn{background:#3a2b12;border-color:#8a5a12;color:#fde68a}
  .btn.danger{background:#3a1515;border-color:#7f1d1d;color:#fecaca}

  .board{width:100%;max-width:720px;aspect-ratio:1/1;position:relative}
  canvas{width:100%;height:100%;display:block;border-radius:16px;background:#0b0e13}
  .streak-badge{
    position:absolute;left:50%;top:10px;transform:translateX(-50%);
    background:#111827;border:1px solid #243042;border-radius:999px;padding:6px 12px;font-weight:800
  }

  /* å††ã®ä¸‹ã«ç½®ãå¤§ãã‚ã®TAPãƒœã‚¿ãƒ³ï¼ˆé•·æ–¹å½¢ï¼‰ */
  .tap-row{width:100%;max-width:720px;margin-top:10px;display:flex;justify-content:center}
  #tapBtn{
    width:min(92%,560px);height:68px;border-radius:16px;border:2px solid #334155;
    background:#0f131a;color:#e5e7eb;font-weight:900;font-size:clamp(18px,5vw,28px);
    letter-spacing:1px;box-shadow:0 6px 18px rgba(0,0,0,.35); user-select:none; -webkit-tap-highlight-color:transparent;
  }
  #tapBtn[disabled]{opacity:.45;filter:saturate(.4)}

  /* ç”»é¢ä¸‹éƒ¨ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆãƒŸãƒ¥ãƒ¼ãƒˆ/ä¸€æ™‚åœæ­¢/ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰ */
  .bottombar{margin-top:10px;width:100%;max-width:720px;display:flex;justify-content:space-between;gap:8px;position:sticky;bottom:0;padding-bottom:4px}
  .ctrls{display:flex;gap:8px;margin:0 auto}
  .hint{font-size:12px;color:var(--muted);text-align:center;margin-top:4px}

  dialog{border:none;border-radius:14px;padding:0;max-width:520px;width:90vw;background:#0f131a;color:var(--fg)}
  .dlg-head{padding:14px 16px;border-bottom:1px solid #253040;font-weight:700}
  .dlg-body{padding:12px 16px}
  .rank-list{width:100%;border-collapse:collapse}
  .rank-list th,.rank-list td{padding:8px 6px;border-bottom:1px solid #1d2533;text-align:left}
  .rank-list th{color:#aab4bf;font-weight:600}
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <button id="startBtn" class="btn primary">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>

    <div class="board">
      <div class="streak-badge">é€£ç¶šæˆåŠŸ: <span id="streak">0</span></div>
      <canvas id="cv"></canvas>
    </div>

    <div class="tap-row">
      <button id="tapBtn" aria-label="Tap to check" disabled>TAP</button>
    </div>

    <div class="bottombar">
      <div class="ctrls">
        <button id="muteBtn" class="btn">ğŸ”ˆ ãƒŸãƒ¥ãƒ¼ãƒˆ</button>
        <button id="pauseBtn" class="btn warn">â¸ ä¸€æ™‚åœæ­¢</button>
        <button id="rankBtn" class="btn accent">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
      </div>
    </div>

    <div class="hint">â€» æˆåŠŸæ™‚ã« <code>success.mp3</code> ã‚’å†ç”Ÿï¼ˆåˆå›æ“ä½œã§è§£æ”¾ï¼‰ã€‚</div>
  </div>

  <dialog id="rankDlg">
    <div class="dlg-head">ğŸ† ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ TOP5</div>
    <div class="dlg-body">
      <table class="rank-list" id="rankTable">
        <thead><tr><th>#</th><th>æ—¥ä»˜</th><th>é€£ç¶šå›æ•°</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
        <button id="closeRank" class="btn">é–‰ã˜ã‚‹</button>
        <button id="resetRank" class="btn danger">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>
  </dialog>

<script>
(() => {
  // ===== èª¿æ•´ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆDBDé¢¨ï¼‰ =====
  const CONFIG = {
    goodArcRatio: 0.18,   // Goodå¹…ï¼ˆå††å‘¨æ¯”ï¼‰
    greatArcRatio: 0.04,  // Greatå¹…ï¼ˆGoodå†…ã‚»ãƒ³ã‚¿ãƒ¼ï¼‰
    baseRPM: 60,          // ã‚¹ã‚¤ãƒ¼ãƒ—ã®åˆæœŸå›è»¢é€Ÿåº¦ï¼ˆRPMï¼‰
    rpmIncrease: 6,       // æˆåŠŸã”ã¨ã«åŠ é€Ÿ
    maxRPM: 180,
    sweepWidthRatio: 0.02,// ç™½ã„ã‚¹ã‚¤ãƒ¼ãƒ—ãƒãƒ¼ã‚«ãƒ¼ã®å¹…ï¼ˆå††å‘¨æ¯”ï¼‰â€»è¦‹ã‚„ã™ã•
    inputCooldownMs: 45   // ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ»èª¤çˆ†é˜²æ­¢
  };

  // ===== è¦ç´  =====
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d', { alpha: false, desynchronized: true });
  const startBtn= document.getElementById('startBtn');
  const pauseBtn= document.getElementById('pauseBtn');
  const muteBtn = document.getElementById('muteBtn');
  const rankBtn = document.getElementById('rankBtn');
  const tapBtn  = document.getElementById('tapBtn');
  const rankDlg = document.getElementById('rankDlg');
  const rankTbd = document.querySelector('#rankTable tbody');
  const closeRank = document.getElementById('closeRank');
  const resetRank = document.getElementById('resetRank');
  const elStreak = document.getElementById('streak');

  // ===== çŠ¶æ…‹ =====
  let running=false, paused=false, muted=false;
  let lastInputAt=0;

  // ã‚¹ã‚¤ãƒ¼ãƒ—ã¯ã€Œé‡ã¯å›ºå®š(12æ™‚)ã€ã§ã€Œã‚¹ã‚¤ãƒ¼ãƒ—è§’ãŒæ™‚é–“ã§å›ã‚‹ã€ã€‚
  let rpm = CONFIG.baseRPM;
  let baseAngle=0;   // now=baseTimeæ™‚ç‚¹ã®ã‚¹ã‚¤ãƒ¼ãƒ—è§’ï¼ˆradï¼‰
  let baseTime=0;    // performance.now()
  let zoneStart=0;   // Goodé–‹å§‹è§’
  const full = Math.PI*2;
  const zoneSize  = full * CONFIG.goodArcRatio;
  const greatSize = full * CONFIG.greatArcRatio;
  const sweepSize = full * CONFIG.sweepWidthRatio; // è¡¨ç¤ºç”¨ç™½ãƒãƒ¼ã‚«ãƒ¼ã®å¹…
  let streak=0;

  // DPRå¯¾å¿œ
  let cssW=0, cssH=0, dpr=1;
  function resizeCanvas(){
    const rect = cv.getBoundingClientRect();
    dpr = Math.max(1, Math.min(3, window.devicePixelRatio||1));
    cssW = rect.width; cssH = rect.height;
    cv.width  = Math.round(cssW * dpr);
    cv.height = Math.round(cssH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    draw(performance.now());
  }
  new ResizeObserver(resizeCanvas).observe(cv);

  // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª
  const successAudio = new Audio('success.mp3');
  successAudio.preload='auto'; successAudio.volume=0.9;
  function unlockAudio(){
    successAudio.play().then(()=>{successAudio.pause();successAudio.currentTime=0;}).catch(()=>{});
    window.removeEventListener('pointerdown', unlockAudio, {once:true});
  }
  window.addEventListener('pointerdown', unlockAudio, {once:true});

  // è§’åº¦ç®—å‡ºï¼ˆä»»æ„æ™‚åˆ»tï¼‰
  function sweepAngleAt(t){
    const rps = rpm / 60;
    const delta = (t - baseTime)/1000;
    const a = baseAngle + rps * full * delta;
    return norm(a);
  }
  function norm(a){ return (a % full + full) % full; }
  function inRange(a,s,e){ return (s<=e) ? (a>=s && a<=e) : (a>=s || a<=e); }

  // æç”»
  function draw(now){
    const w = cssW, h = cssH;
    const CX = w/2, CY = h/2;
    const rOuter = Math.min(w,h)*0.42;
    const rInner = rOuter - 36;

    const sweepCenter = sweepAngleAt(now);

    ctx.clearRect(0,0,w,h);

    // èƒŒæ™¯å††
    ctx.beginPath(); ctx.arc(CX, CY, rOuter+24, 0, full);
    ctx.fillStyle = '#0a0d12'; ctx.fill();

    // ãƒ™ãƒ¼ã‚¹ãƒªãƒ³ã‚°
    ctx.beginPath(); ctx.arc(CX, CY, rOuter, 0, full);
    ctx.lineWidth = 24; ctx.strokeStyle = '#1a2330'; ctx.stroke();

    // Goodã‚¾ãƒ¼ãƒ³ï¼ˆç·‘ï¼‰
    ctx.beginPath(); ctx.lineWidth=24; ctx.strokeStyle='#10b981';
    ctx.arc(CX, CY, rOuter, zoneStart, zoneStart+zoneSize); ctx.stroke();

    // Greatã‚¾ãƒ¼ãƒ³ï¼ˆé»„ï¼‰Goodã®ä¸­å¤®
    const greatStart = zoneStart + (zoneSize - greatSize)/2;
    ctx.beginPath(); ctx.lineWidth=24; ctx.strokeStyle='#fbbf24';
    ctx.arc(CX, CY, rOuter, greatStart, greatStart+greatSize); ctx.stroke();

    // ã‚¹ã‚¤ãƒ¼ãƒ—ï¼ˆç™½ãƒãƒ¼ã‚«ãƒ¼ï¼‰â€” å›ã£ã¦ãã‚‹ã‚„ã¤
    ctx.beginPath(); ctx.lineWidth=24; ctx.strokeStyle='#e5e7eb';
    ctx.shadowColor = '#93c5fd'; ctx.shadowBlur = 8;
    ctx.arc(CX, CY, rOuter, sweepCenter - sweepSize/2, sweepCenter + sweepSize/2); ctx.stroke();
    ctx.shadowBlur = 0;

    // å›ºå®šé‡ï¼ˆ12æ™‚æ–¹å‘ï¼‰
    ctx.save(); ctx.translate(CX, CY); ctx.rotate(0); // 12æ™‚ = è§’åº¦0åŸºæº–ã‚’ä¸Šã«
    // 12æ™‚æ–¹å‘ã«å‘ãã‚ˆã†è£œæ­£ï¼šã‚­ãƒ£ãƒ³ãƒã‚¹ã¯é€šå¸¸0radãŒå³ãªã®ã§ã€-90åº¦å›è»¢ã—ã¦ã‹ã‚‰æã
    ctx.rotate(-Math.PI/2);
    ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0, -rInner);
    ctx.lineWidth = 6; ctx.strokeStyle = '#e5e7eb'; ctx.stroke();
    ctx.restore();

    // ãƒ©ãƒ™ãƒ«
    ctx.fillStyle = '#9aa4af';
    ctx.font = '700 22px system-ui, -apple-system, Segoe UI';
    ctx.textAlign = 'center';
    ctx.fillText(`æ€’æ¶›ã®åµ é€£ç¶š ${streak}`, CX, CY+10);
  }

  // ãƒ«ãƒ¼ãƒ—
  function loop(now){
    if(!running){ return; }
    if(!paused){ draw(now); }
    requestAnimationFrame(loop);
  }

  // ã‚¾ãƒ¼ãƒ³å†é…ç½®
  function randomizeZone(){
    // 12æ™‚ç›´è¿‘ã°ã‹ã‚Šæ¥ãªã„ã‚ˆã†å°‘ã—ãƒãƒ©ã™
    const pad = 0.15;
    zoneStart = norm(Math.random()*full + (Math.random()*pad - pad/2));
  }

  // å…¥åŠ›ï¼ˆTAPã—ãŸç¬é–“ã®æ™‚åˆ»ã§åˆ¤å®šï¼‰
  function onTap(ev){
    if(!running || paused) return;
    const now = ev?.timeStamp ? performance.now() : performance.now(); // å®Ÿè£…ç›¸æ€§ã®ãŸã‚ç°¡ç•¥ï¼ˆmodernç’°å¢ƒãªã‚‰ev.timeStampã§ã‚‚OKï¼‰
    if(now - lastInputAt < CONFIG.inputCooldownMs) return;
    lastInputAt = now;

    const a = sweepAngleAt(now);
    // æˆåŠŸåˆ¤å®šã¯ã€Œå›ºå®šé‡ãŒ12æ™‚ï¼0radã«ã„ã‚‹ã¨ãã€ã‚¹ã‚¤ãƒ¼ãƒ—ä¸­å¿ƒãŒGoodç¯„å›²å†…ã‹ã€ã§è¦‹ã‚‹
    // Good/Greetã¯ãƒªãƒ³ã‚°ä¸Šã®è§’åº¦ã§å®šç¾©æ¸ˆã¿
    const s = zoneStart;
    const e = norm(zoneStart + zoneSize);
    const ok = inRange(a, s, e);

    if(ok){
      // è¦‹ãŸç›®ã¨å†…éƒ¨ã‚’ä¸€è‡´ã•ã›ã‚‹ï¼šã“ã“ã‚’åŸºæº–ã«å–ã‚Šç›´ã—
      baseAngle = a; baseTime = now;
      playSuccess();
      streak++; elStreak.textContent = String(streak);
      rpm = Math.min(CONFIG.maxRPM, rpm + CONFIG.rpmIncrease);
      randomizeZone();
      draw(now);
    }else{
      gameOver();
    }
  }

  // ã‚µã‚¦ãƒ³ãƒ‰
  const playSuccess = () => { if(muted) return; try{ successAudio.currentTime=0; successAudio.play().catch(()=>{});}catch(_){} };

  // åˆ¶å¾¡
  function startGame(){
    resizeCanvas();
    running=true; paused=false; streak=0; elStreak.textContent='0';
    rpm = CONFIG.baseRPM; baseAngle=0; baseTime=performance.now();
    randomizeZone();
    tapBtn.disabled=false;
    requestAnimationFrame(loop);
  }
  function pauseGame(){
    if(!running) return;
    paused = !paused;
    pauseBtn.textContent = paused ? 'â–¶ å†é–‹' : 'â¸ ä¸€æ™‚åœæ­¢';
    // å†é–‹ç›´å¾Œã‚ºãƒ¬é˜²æ­¢
    const now = performance.now();
    baseAngle = sweepAngleAt(now);
    baseTime = now;
    draw(now);
  }
  function stopGame(){ running=false; paused=false; tapBtn.disabled=true; }
  function gameOver(){
    stopGame();
    saveScore({score:streak, at:Date.now()});
    renderRanking();
  }

  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆåå‰ç„¡ã—ï¼šæ—¥ä»˜ï¼‹é€£ç¶šå›æ•°ï¼‰
  const KEY='skillcheck_top5_sweep_noname_v1';
  function loadScores(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch{return []} }
  function saveScore(entry){
    if(entry.score<=0) return;
    const arr = loadScores(); arr.push(entry);
    arr.sort((a,b)=> b.score - a.score || b.at - a.at);
    localStorage.setItem(KEY, JSON.stringify(arr.slice(0,5)));
  }
  function renderRanking(){
    const arr = loadScores(); rankTbd.innerHTML='';
    arr.forEach((e,i)=>{
      const dt=new Date(e.at);
      const d=`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${i+1}</td><td>${d}</td><td>${e.score}</td>`;
      rankTbd.appendChild(tr);
    });
  }
  function resetRanking(){ localStorage.removeItem(KEY); renderRanking(); }

  // ã‚¤ãƒ™ãƒ³ãƒˆ
  startBtn.addEventListener('click', startGame, {passive:true});
  pauseBtn.addEventListener('click', pauseGame, {passive:true});
  muteBtn.addEventListener('click', ()=>{ muted=!muted; successAudio.muted=muted; muteBtn.textContent = muted?'ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆä¸­':'ğŸ”ˆ ãƒŸãƒ¥ãƒ¼ãƒˆ'; }, {passive:true});
  rankBtn.addEventListener('click', ()=>{ renderRanking(); rankDlg.showModal(); }, {passive:true});
  closeRank.addEventListener('click', ()=>rankDlg.close(), {passive:true});
  resetRank.addEventListener('click', ()=>{ if(confirm('ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã§ï¼Ÿ')) resetRanking(); }, {passive:true});

  // å…¥åŠ›ï¼šé…å»¶ã®å°‘ãªã„pointerdown
  tapBtn.addEventListener('pointerdown', (e)=>{ e.preventDefault(); onTap(e); }, {passive:false});
  // ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ã‚‚åˆ¤å®š
  window.addEventListener('keydown', (e)=>{ if(e.code==='Space'){ e.preventDefault(); onTap(); } });

  // åˆæœŸ
  renderRanking();
  requestAnimationFrame(resizeCanvas);
})();
</script>
</body>
</html>
