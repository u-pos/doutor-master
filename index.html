<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DBDスキルチェック：怒涛の嵐（真反対スタート／細枠／ゾーン半分）</title>
<style>
  :root{ --bg:#0f1115; --fg:#eaeef2; --muted:#9aa4af; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{min-height:100dvh;display:flex;flex-direction:column;align-items:center;gap:12px;padding:12px}
  .board{width:100%;max-width:720px;aspect-ratio:1/1;position:relative}
  canvas{width:100%;height:100%;display:block;border-radius:16px;background:#0b0e13}
  .overlay{
    position:absolute;inset:0;display:none;align-items:center;justify-content:center;
    font-weight:900;font-size:clamp(28px,8vw,56px);background:rgba(0,0,0,.25);backdrop-filter:saturate(120%) blur(1px);
  }
  .overlay.show{display:flex}
  .tap-row{width:100%;max-width:720px;margin-top:10px;display:flex;justify-content:center}
  #tapBtn{
    width:min(92%,560px);height:72px;border-radius:16px;border:2px solid #334155;background:#0f131a;color:#e5e7eb;
    font-weight:900;font-size:clamp(18px,5vw,28px);letter-spacing:1px;box-shadow:0 6px 18px rgba(0,0,0,.35);
    user-select:none;-webkit-tap-highlight-color:transparent
  }
  #tapBtn[disabled]{opacity:.45;filter:saturate(.4)}
  .bottombar{margin-top:10px;width:100%;max-width:720px;display:flex;justify-content:center;gap:8px}
  .btn{border:1px solid #26303a;background:#1f2937;color:var(--fg);border-radius:12px;padding:10px 16px;font-weight:800;cursor:pointer}
  .btn.warn{background:#3a2b12;border-color:#8a5a12;color:#fde68a}
  .btn.alt{background:#122031;border-color:#2a3f59}

  dialog{border:none;border-radius:14px;padding:0;max-width:520px;width:90vw;background:#0f131a;color:var(--fg)}
  .dlg-head{padding:14px 16px;border-bottom:1px solid #253040;font-weight:700}
  .dlg-body{padding:12px 16px}
  .rank-list{width:100%;border-collapse:collapse}
  .rank-list th,.rank-list td{padding:8px 6px;border-bottom:1px solid #1d2533;text-align:left}
  .rank-list th{color:#aab4bf;font-weight:600}
  .hint{font-size:12px;color:var(--muted);text-align:center;margin-top:4px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="board">
      <canvas id="cv"></canvas>
      <div id="overlay" class="overlay"></div>
    </div>

    <div class="tap-row">
      <button id="tapBtn" aria-label="Tap to stop" disabled>TAP</button>
    </div>

    <div class="bottombar">
      <button id="startBtn" class="btn">▶ スタート</button>
      <button id="pauseBtn" class="btn warn">⏸ 一時停止</button>
      <button id="rankBtn" class="btn alt">🏆 ランキング</button>
    </div>

    <div class="hint">成功: <code>success.mp3</code>／失敗: <code>bomb.mp3</code></div>
  </div>

  <dialog id="rankDlg">
    <div class="dlg-head">🏆 オフライン TOP5</div>
    <div class="dlg-body">
      <table class="rank-list" id="rankTable">
        <thead><tr><th>#</th><th>日付</th><th>連続回数</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
        <button id="closeRank" class="btn">閉じる</button>
        <button id="resetRank" class="btn warn">リセット</button>
      </div>
    </div>
  </dialog>

<script>
(() => {
  const CONFIG = {
    baseRPM: 60,
    inputCooldownMs: 45,
    nextZoneMinDeg: 180,
    nextZoneMaxDeg: 220,
    countdownMs: 1500
  };

  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d', { alpha: false, desynchronized: true });
  const startBtn= document.getElementById('startBtn');
  const pauseBtn= document.getElementById('pauseBtn');
  const rankBtn = document.getElementById('rankBtn');
  const tapBtn  = document.getElementById('tapBtn');
  const overlay = document.getElementById('overlay');
  const rankDlg = document.getElementById('rankDlg');
  const rankTbd = document.querySelector('#rankTable tbody');
  const closeRank = document.getElementById('closeRank');
  const resetRank = document.getElementById('resetRank');

  let running=false, paused=false;
  let phase = 'idle';
  let lastInputAt=0;
  let streak=0;

  const FULL = Math.PI*2;
  const zoneSize = FULL * 0.08;  // ★白ゾーン幅を半分に
  const rpm = CONFIG.baseRPM;

  let baseAngle=0, baseTime=0;
  let frozenAngle=0;
  let zoneStart=0;
  let lastAngle=null, lastInside=false;

  let cssW=0, cssH=0, dpr=1;
  function resizeCanvas(){
    const rect = cv.getBoundingClientRect();
    dpr = Math.max(1, Math.min(3, window.devicePixelRatio||1));
    cssW = rect.width; cssH = rect.height;
    cv.width  = Math.round(cssW * dpr);
    cv.height = Math.round(cssH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    draw(performance.now(), getCurrentAngle(performance.now()));
  }
  new ResizeObserver(resizeCanvas).observe(cv);

  const successAudio = new Audio('success.mp3');
  const bombAudio    = new Audio('bomb.mp3');
  [successAudio, bombAudio].forEach(a => { a.preload='auto'; a.volume=0.9; });

  const norm = a => (a % FULL + FULL) % FULL;
  function angleAt(t){
    const rps = rpm / 60;
    const delta = (t - baseTime)/1000;
    return norm(baseAngle + rps * FULL * delta);
  }
  function getCurrentAngle(t){
    return (phase === 'play') ? angleAt(t) : frozenAngle;
  }
  const inRange = (a,s,e) => (s<=e) ? (a>=s && a<=e) : (a>=s || a<=e);
  const cwDelta = (from,to)=>(to-from+FULL)%FULL;

  function draw(now, angle){
    const w = cssW, h = cssH;
    const CX = w/2, CY = h/2;
    const rOuter = Math.min(w,h)*0.42;

    ctx.clearRect(0,0,w,h);

    // 外枠グレーリング（2px）
    ctx.beginPath(); ctx.arc(CX, CY, rOuter, 0, FULL);
    ctx.lineWidth = 2;                  // ★ここを2px
    ctx.strokeStyle = '#1a2330'; ctx.stroke();

    // 白ゾーン
    ctx.beginPath(); ctx.lineWidth = 24; ctx.strokeStyle = '#ffffff';
    ctx.arc(CX, CY, rOuter, zoneStart, zoneStart+zoneSize); ctx.stroke();

    // 赤い針（半径より少し長め）
    const front = rOuter * 1.2;
    const back  = rOuter * 0.2;
    ctx.save(); ctx.translate(CX, CY);
    ctx.rotate(angle - Math.PI/2);
    ctx.beginPath();
    ctx.moveTo(0, back);
    ctx.lineTo(0, -front);
    ctx.lineWidth = 6; ctx.strokeStyle = '#ef4444';
    ctx.stroke();
    ctx.restore();
  }

  function loop(now){
    if(!running) return;
    const ang = getCurrentAngle(now);
    draw(now, ang);
    requestAnimationFrame(loop);
  }

  function setupInitialZoneAndNeedle(){
    const zoneCenter = Math.random()*FULL;
    zoneStart = norm(zoneCenter - zoneSize/2);
    frozenAngle = norm(zoneCenter + Math.PI); // ★針＝ゾーン中心の真反対
    lastInside=false; lastAngle=null;
  }

  function startGame(){
    resizeCanvas();
    running=true; paused=false; streak=0;
    setupInitialZoneAndNeedle();
    const t0 = performance.now();
    overlay.classList.add('show');
    overlay.textContent = 'Ready';
    tapBtn.disabled = true;
    phase='countdown';
    setTimeout(()=>{ overlay.textContent='GO!'; }, CONFIG.countdownMs*0.6);
    setTimeout(()=>{
      overlay.classList.remove('show');
      baseAngle=frozenAngle; baseTime=performance.now();
      phase='play'; tapBtn.disabled=false;
    }, CONFIG.countdownMs);
    requestAnimationFrame(loop);
  }

  function pauseGame(){}

  function gameOver(){
    bombAudio.currentTime=0; bombAudio.play().catch(()=>{});
    running=false; phase='idle'; tapBtn.disabled=true;
  }

  startBtn.addEventListener('click', startGame);
})();
</script>
</body>
</html>
