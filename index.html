<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>スキルチェックゲーム</title>
<style>
  :root{ --bg:#0f1115; --fg:#eaeef2; --muted:#9aa4af; --accent:#7dd3fc; --pink:#f472b6; --green:#34d399; --amber:#fbbf24;}
  html,body{
    margin:0;height:100%;
    background:var(--bg);color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    touch-action:manipulation; -webkit-user-select:none; user-select:none; -webkit-touch-callout:none;
  }
  header.title{
    width:100%; display:flex; justify-content:center; align-items:center;
    padding:14px 8px; margin:0;
    background:linear-gradient(90deg, #0b1220, #0e1626);
    border-bottom:1px solid #1f2b3a;
  }
  header.title h1{
    margin:0; font-size:clamp(20px,5vw,28px); letter-spacing:.06em; font-weight:900;
    background:linear-gradient(180deg, #eaf2ff, #9bd5ff 60%, #79c3ff);
    -webkit-background-clip:text; background-clip:text; color:transparent;
    text-shadow:0 2px 18px rgba(125,211,252,.15);
  }

  .wrap{min-height:calc(100dvh - 60px);display:flex;flex-direction:column;align-items:center;gap:10px;padding:10px}
  .board{width:100%;max-width:720px;position:relative;aspect-ratio:1/1}
  canvas#cv{width:100%;height:100%;display:block;border-radius:16px;background:#0b0e13;touch-action:none}
  .overlay{
    position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:2;
    font-weight:900;font-size:clamp(28px,8vw,56px);background:rgba(0,0,0,.25);backdrop-filter:saturate(120%) blur(1px);
  }
  .overlay.show{display:flex}

  /* 初回メッセージ */
  .welcome{
    position:absolute;inset:0;display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;z-index:3;
    text-align:center;background:rgba(0,0,0,.25);
  }
  .welcome h2{
    margin:0; font-size:clamp(24px,7vw,44px); font-weight:900; letter-spacing:.04em;
    background:linear-gradient(180deg, #fff, #a7f3d0 60%, #6ee7b7);
    -webkit-background-clip:text; background-clip:text; color:transparent;
    text-shadow:0 2px 20px rgba(110,231,183,.25);
  }

  .tap-row{width:100%;max-width:820px;margin-top:8px;display:flex;justify-content:center}
  #tapBtn{
    width:min(92%,560px);height:72px;border-radius:16px;border:2px solid #334155;background:#0f131a;color:#e5e7eb;
    font-weight:900;font-size:clamp(18px,5vw,28px);letter-spacing:1px;box-shadow:0 6px 18px rgba(0,0,0,.35);
    user-select:none;-webkit-tap-highlight-color:transparent; touch-action:manipulation; cursor:pointer;
  }
  #tapBtn[disabled]{opacity:.45;filter:saturate(.4);cursor:not-allowed}

  /* 下部ボタン：スタートを目立たせる／他はアイコンのみ */
  .bottombar{margin-top:10px;width:100%;max-width:820px;display:flex;justify-content:center;gap:10px;flex-wrap:wrap}
  .btn{
    border:1px solid #26303a;background:#1f2937;color:var(--fg);border-radius:14px;padding:12px 18px;
    font-weight:900;cursor:pointer;touch-action:manipulation;-webkit-tap-highlight-color:transparent
  }
  #startBtn{
    background:linear-gradient(180deg, #34d399, #10b981);
    border-color:#065f46; color:#062e26;
    box-shadow:0 10px 28px rgba(16,185,129,.35);
    font-size:clamp(18px,5vw,22px); padding:14px 24px; letter-spacing:.04em;
  }
  .icon-btn{
    width:56px; height:56px; padding:0; display:inline-flex; align-items:center; justify-content:center;
    font-size:26px; border-radius:14px;
  }
  .btn.alt{background:#122031;border-color:#2a3f59}

  dialog{border:none;border-radius:14px;padding:0;max-width:520px;width:90vw;background:#0f131a;color:#fff}
  .dlg-head{padding:14px 16px;border-bottom:1px solid #253040;font-weight:700}
  .dlg-body{padding:12px 16px}
  .rank-list{width:100%;border-collapse:collapse}
  .rank-list th,.rank-list td{padding:8px 6px;border-bottom:1px solid #1d2533;text-align:left}
  .rank-list th{color:#aab4bf;font-weight:600}

  /* 100達成演出（紙吹雪） */
  .celebrate{
    position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:4;display:none;
  }
  .celebrate.show{display:block;}
  .con{position:absolute; width:8px; height:14px; opacity:.9; border-radius:2px;
       animation: fall linear forwards;}
  @keyframes fall{
    0%{ transform:translateY(-10vh) rotate(0deg); }
    100%{ transform:translateY(110vh) rotate(720deg); }
  }
</style>
</head>
<body>
  <header class="title"><h1>スキルチェックゲーム</h1></header>

  <div class="wrap">
    <div class="board" id="board">
      <canvas id="cv"></canvas>

      <!-- 初回メッセージ -->
      <div id="welcome" class="welcome">
        <h2>目指せ100連続！</h2>
      </div>

      <!-- Ready/GO など -->
      <div id="overlay" class="overlay"></div>

      <!-- 紙吹雪 -->
      <div id="celebrate" class="celebrate"></div>
    </div>

    <div class="tap-row">
      <button id="tapBtn" aria-label="Tap to stop" disabled>TAP</button>
    </div>

    <!-- 下部：スタート／ミュート（アイコン）／ランキング（アイコン） -->
    <div class="bottombar">
      <button id="startBtn" class="btn">▶ スタート</button>
      <button id="muteBtn"  class="btn icon-btn" aria-label="ミュート切替">🔊</button>
      <button id="rankBtn"  class="btn alt icon-btn" aria-label="ランキング">🏆</button>
    </div>
  </div>

  <dialog id="rankDlg">
    <div class="dlg-head">🏆 オフライン TOP5</div>
    <div class="dlg-body">
      <table class="rank-list" id="rankTable">
        <thead><tr><th>#</th><th>日付</th><th>連続回数</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
        <button id="closeRank" class="btn">閉じる</button>
      </div>
    </div>
  </dialog>

<script>
(() => {
  // ========= 設定 =========
  const CONFIG = {
    RPM: 60,                 // 一定速度
    ZONE_RATIO: 0.12,        // ★白ゾーン角度幅（ご要望どおり 0.12）
    INPUT_CD_MS: 45,         // 誤爆防止
    NEXT_MIN_DEG: 180,       // 成功後：成功角 + [180°,220°] に次ゾーン中心
    NEXT_MAX_DEG: 220,
    COUNTDOWN_MS: 1500,      // Ready→GO（針は止める）
    TARGET_STREAK: 100       // 100到達で祝う＆終了
  };

  // ========= 要素 =========
  const $ = (id) => document.getElementById(id);
  const board=$('board'), cv=$('cv'), ctx=cv.getContext('2d', {alpha:false, desynchronized:true});
  const tapBtn=$('tapBtn'), startBtn=$('startBtn'), muteBtn=$('muteBtn'), rankBtn=$('rankBtn');
  const overlay=$('overlay'), welcome=$('welcome'), rankDlg=$('rankDlg'), rankTbd=document.querySelector('#rankTable tbody');
  const closeRank=$('closeRank');
  const celebrateBox=$('celebrate');

  // ========= 状態 =========
  let phase='idle', paused=false, streak=0, lastInputAt=0, rafId=0, isMuted=false;
  const FULL=Math.PI*2;
  const ZONE_SIZE=FULL*CONFIG.ZONE_RATIO;
  let baseAngle=0, baseTime=0, frozenAngle=0, zoneStart=0;
  let lastAngle=null, lastInside=false;

  // ========= レイアウト =========
  let cssW=0, cssH=0, dpr=1;
  function ensureSquare(){
    const bw = board.clientWidth || board.getBoundingClientRect().width || 300;
    board.style.height = bw + 'px';
  }
  function resizeCanvas(){
    ensureSquare();
    const rect = cv.getBoundingClientRect();
    dpr = Math.max(1, Math.min(3, window.devicePixelRatio||1));
    cssW = rect.width||300; cssH = rect.height||300;
    cv.width  = Math.round(cssW * dpr);
    cv.height = Math.round(cssH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    draw(getCurrentAngle(performance.now()));
  }
  window.addEventListener('resize', resizeCanvas);
  if (window.ResizeObserver) { try { new ResizeObserver(()=>resizeCanvas()).observe(board); } catch {} }
  requestAnimationFrame(resizeCanvas);

  // ========= Web Audio：事前デコード＋フォールバック =========
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let actx, gMaster, buf = {success:null, bomb:null, ready:null, fanfare:null}, html={};
  function setupHtmlFallback(){
    ['success','bomb','ready','fanfare'].forEach(k=>{
      const a = new Audio(`${k}.mp3`);
      a.preload='auto'; a.playsInline = true;
      try{ a.volume = 0.9; }catch{}
      html[k]=a;
    });
  }
  setupHtmlFallback();

  async function unlockAndWarmAudio() {
    try {
      if (!actx) {
        actx = new AudioCtx({ latencyHint: 'interactive' });
        gMaster = actx.createGain();
        gMaster.gain.value = 1.0;
        gMaster.connect(actx.destination);
      }
      if (actx.state === 'suspended') await actx.resume();
      await Promise.all(['success','bomb','ready','fanfare'].map(async k=>{
        if (buf[k]) return;
        const res = await fetch(`${k}.mp3`);
        const ab = await res.arrayBuffer();
        buf[k] = await actx.decodeAudioData(ab);
      }));
    } catch(e) {
      console.warn('WebAudio warm failed', e);
    }
  }
  function setMuted(m){
    isMuted = m;
    if (gMaster) gMaster.gain.value = isMuted ? 0 : 1;
    Object.values(html).forEach(a=>{ a.muted = isMuted; });
    muteBtn.textContent = isMuted ? '🔇' : '🔊';
  }
  function playBuf(key, gain=0.9){
    try{
      if (!actx || !buf[key]) return false;
      const src = actx.createBufferSource();
      const g   = actx.createGain();
      g.gain.value = gain;
      src.buffer = buf[key];
      src.connect(g).connect(gMaster || actx.destination);
      src.start(actx.currentTime);
      return true;
    }catch(e){ console.warn('WebAudio play failed', key, e); return false; }
  }
  async function playSE(key){
    if (isMuted) return;
    if (!buf[key]) { await unlockAndWarmAudio(); }
    if (!playBuf(key, 0.9) && html[key]) {
      try{ html[key].currentTime=0; await html[key].play(); }catch(e){}
    }
  }
  window.addEventListener('pointerdown', () => { unlockAndWarmAudio(); }, { once:true });

  // ========= iOSのズーム抑止 =========
  document.addEventListener('dblclick', e=>e.preventDefault(), {passive:false});
  ['gesturestart','gesturechange','gestureend'].forEach(ev=> window.addEventListener(ev, e=>e.preventDefault(), {passive:false}));

  // ========= 角度 & 描画 =========
  const norm = a => (a % FULL + FULL) % FULL;
  const inRange = (a,s,e)=> (s<=e) ? (a>=s && a<=e) : (a>=s || a<=e);
  const cwDelta = (from,to)=> (to - from + FULL) % FULL;
  const angleAt = (t) => {
    const rps = CONFIG.RPM/60;
    const delta = (t - baseTime)/1000;
    return norm(baseAngle + rps*FULL*delta);
  };
  const getCurrentAngle = (t) => (phase==='play') ? angleAt(t) : frozenAngle;

  function draw(angle){
    const w=cssW, h=cssH, CX=w/2, CY=h/2, r=Math.min(w,h)*0.42;
    ctx.clearRect(0,0,w,h);

    // 外枠 2px
    ctx.beginPath(); ctx.arc(CX, CY, r, 0, FULL);
    ctx.lineWidth=2; ctx.strokeStyle='#1a2330'; ctx.stroke();

    // 白ゾーン
    ctx.beginPath(); ctx.lineWidth=24; ctx.strokeStyle='#ffffff';
    ctx.arc(CX, CY, r, zoneStart, zoneStart+ZONE_SIZE); ctx.stroke();

    // 赤針（前1.2R／後0.2R）
    const front=r*1.2, back=r*0.2;
    const fx=CX+front*Math.cos(angle), fy=CY+front*Math.sin(angle);
    const bx=CX-back *Math.cos(angle), by=CY-back *Math.sin(angle);
    ctx.beginPath(); ctx.moveTo(bx,by); ctx.lineTo(fx,fy);
    ctx.lineWidth=6; ctx.strokeStyle='#ef4444'; ctx.stroke();

    // ★ コンボ数字（中心より少し上）
    const combo = String(streak);
    ctx.save();
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.font = `900 ${Math.max(18, Math.round(r*0.32))}px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif`;
    // 立体感のあるアウトライン
    ctx.lineWidth = Math.max(2, Math.round(r*0.04));
    ctx.strokeStyle = 'rgba(0,0,0,0.55)';
    ctx.strokeText(combo, CX, CY - r*0.18);
    ctx.fillStyle = '#eaeef2';
    ctx.fillText(combo, CX, CY - r*0.18);
    ctx.restore();
  }

  // ========= ループ =========
  function loop(now){
    const ang=getCurrentAngle(now);
    draw(ang);

    if(phase==='play' && !paused){
      const zoneEnd=norm(zoneStart+ZONE_SIZE);
      const inside=inRange(ang, zoneStart, zoneEnd);
      if(lastAngle!==null && lastInside && !inside){
        const moved=cwDelta(lastAngle, ang);
        const toEnd=cwDelta(lastAngle, zoneEnd);
        if(moved>=toEnd){ return gameOver(); } // ゾーン通過し切り
      }
      lastInside=inside; lastAngle=ang;
    }
    rafId=requestAnimationFrame(loop);
  }

  // ========= ゲームロジック =========
  function setupInitial(){
    const center=Math.random()*FULL;
    zoneStart = norm(center - ZONE_SIZE/2);
    frozenAngle = norm(center + Math.PI); // 針＝ゾーン中心の真反対
    lastInside=false; lastAngle=null;
  }
  function moveZoneAfterSuccess(successAngle){
    const min=CONFIG.NEXT_MIN_DEG*Math.PI/180, max=CONFIG.NEXT_MAX_DEG*Math.PI/180;
    const nextCenter=norm(successAngle + (min + Math.random()*(max-min)));
    zoneStart=norm(nextCenter - ZONE_SIZE/2);
    lastInside=false; lastAngle=null;
  }

  async function onTap(){
    if(phase!=='play' || paused) return;
    const now=performance.now();
    if(now-lastInputAt<CONFIG.INPUT_CD_MS) return;
    lastInputAt=now;

    const a=angleAt(now);
    const ok=inRange(a, zoneStart, norm(zoneStart+ZONE_SIZE));
    if(ok){
      await playSE('success');
      streak++;
      if(streak >= CONFIG.TARGET_STREAK){
        return celebrateAndEnd();
      }
      baseAngle=a; baseTime=now;
      moveZoneAfterSuccess(a);
      draw(a);
    }else{
      gameOver();
    }
  }

  function showCountdown(){
    overlay.classList.add('show');
    overlay.textContent='Ready';
    tapBtn.disabled=true; phase='countdown';
    const t0=performance.now(), mid=t0+CONFIG.COUNTDOWN_MS*0.6, end=t0+CONFIG.COUNTDOWN_MS;

    const tick=()=>{
      const now=performance.now();
      if(now>=end){
        overlay.classList.remove('show');
        baseAngle=frozenAngle; baseTime=now;
        phase='play'; tapBtn.disabled=false;
        const ang=angleAt(now);
        lastAngle=ang; lastInside=inRange(ang, zoneStart, norm(zoneStart+ZONE_SIZE));
        return;
      }
      if(now>=mid) overlay.textContent = 'GO!';
      requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);
  }

  async function startGame(){
    // 初回メッセージを隠す
    welcome.style.display='none';
    await playSE('ready');           // スタートで ready.mp3
    if(rafId) cancelAnimationFrame(rafId);
    paused=false; streak=0;
    setupInitial();
    resizeCanvas();
    showCountdown();
    rafId=requestAnimationFrame(loop);
  }

  async function gameOver(){
    await playSE('bomb');
    stopGame(true);
    saveScore({score:streak, at:Date.now()});
    renderRanking();
  }

  function stopGame(keepOverlay){
    phase='idle'; tapBtn.disabled=true;
    if(rafId) cancelAnimationFrame(rafId);
    if(!keepOverlay) overlay.classList.remove('show');
  }

  // ========= 100達成：祝う演出＋強制終了 =========
  async function celebrateAndEnd(){
    stopGame(true);
    await playSE('fanfare');
    overlay.textContent = 'おめでとう！！<br />100回達成だよ🎉';
    overlay.classList.add('show');
    runConfetti(200, 2800);
    saveScore({score:streak, at:Date.now()});
    renderRanking();
  }

  function runConfetti(n=150, dur=2500){
    celebrateBox.innerHTML='';
    celebrateBox.classList.add('show');
    const colors=['#60a5fa','#f472b6','#34d399','#fbbf24','#c084fc','#fca5a5','#4ade80'];
    const w=celebrateBox.clientWidth||window.innerWidth;
    for(let i=0;i<n;i++){
      const d=document.createElement('div');
      d.className='con';
      d.style.left = (Math.random()*w) + 'px';
      d.style.background = colors[i%colors.length];
      d.style.animationDuration = (1.8 + Math.random()*1.6) + 's';
      d.style.animationDelay = (Math.random()*0.2) + 's';
      d.style.transform = `translateY(-10vh) rotate(${Math.random()*360}deg)`;
      celebrateBox.appendChild(d);
    }
    setTimeout(()=>{ celebrateBox.classList.remove('show'); celebrateBox.innerHTML=''; }, dur);
  }

  // ========= ランキング =========
  const KEY='skillcheck_top5_goal100_v2';
  const loadScores=()=>{ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch{return []} };
  function saveScore(e){
    if(e.score<=0) return;
    const arr=loadScores(); arr.push(e);
    arr.sort((a,b)=> b.score-a.score || b.at-a.at);
    localStorage.setItem(KEY, JSON.stringify(arr.slice(0,5)));
  }
  function renderRanking(){
    const arr=loadScores(); rankTbd.innerHTML='';
    arr.forEach((e,i)=>{
      const dt=new Date(e.at);
      const d=`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${i+1}</td><td>${d}</td><td>${e.score}</td>`;
      rankTbd.appendChild(tr);
    });
  }

  // ========= イベント =========
  startBtn.addEventListener('click', (e)=>{ e.preventDefault(); startGame(); }, {passive:false});
  muteBtn .addEventListener('click', (e)=>{ e.preventDefault(); setMuted(!isMuted); }, {passive:false});
  rankBtn .addEventListener('click', (e)=>{ e.preventDefault(); renderRanking(); if(rankDlg?.showModal){ rankDlg.showModal(); } }, {passive:false});
  closeRank?.addEventListener('click', (e)=>{ e.preventDefault(); if(rankDlg?.close){ rankDlg.close(); } }, {passive:false});
  tapBtn.addEventListener('pointerdown', (e)=>{ e.preventDefault(); onTap(); }, {passive:false});
  window.addEventListener('keydown', (e)=>{ if(e.code==='Space'){ e.preventDefault(); onTap(); } });

  // 初期
  setMuted(false);
  renderRanking();
})();
</script>
</body>
</html>
