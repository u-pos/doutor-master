<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>„Çπ„Ç≠„É´„ÉÅ„Çß„ÉÉ„ÇØ„Ç≤„Éº„É†</title>
<style>
  :root{ --bg:#0f1115; --fg:#eaeef2; --muted:#9aa4af; --accent:#7dd3fc; --green:#34d399; }
  html,body{
    margin:0;height:100%;
    background:var(--bg);color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    overscroll-behavior:none;touch-action:none;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;
  }
  header.title{width:100%;display:flex;justify-content:center;align-items:center;padding:14px 8px;margin:0;
    background:linear-gradient(90deg,#0b1220,#0e1626);border-bottom:1px solid #1f2b3a}
  header.title h1{margin:0;font-size:clamp(20px,5vw,28px);letter-spacing:.06em;font-weight:900;
    background:linear-gradient(180deg,#eaf2ff,#9bd5ff 60%,#79c3ff);-webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 2px 18px rgba(125,211,252,.15)}
  .wrap{min-height:calc(100dvh - 60px);display:flex;flex-direction:column;align-items:center;gap:10px;padding:10px}
  .board{width:100%;max-width:720px;position:relative;aspect-ratio:1/1}
  #cv{width:100%;height:100%;display:block;border-radius:16px;background:#0b0e13}
  .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:3;font-weight:900;
    font-size:clamp(28px,8vw,56px);background:rgba(0,0,0,.25);backdrop-filter:saturate(120%) blur(1px);text-align:center;padding:12px}
  .overlay.show{display:flex}
  .welcome{position:absolute;inset:0;display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;z-index:2;
    text-align:center;background:rgba(0,0,0,.25);transform:translateY(10%)}
  .welcome h2{margin:0;font-size:clamp(24px,7vw,44px);font-weight:900;letter-spacing:.04em;
    background:linear-gradient(180deg,#fff,#a7f3d0 60%,#6ee7b7);-webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 2px 20px rgba(110,231,183,.25)}
  .tap-row{width:100%;max-width:820px;margin-top:4px;display:flex;justify-content:center}
  #tapBtn{width:min(92%,620px);height:92px;border-radius:18px;border:2px solid #334155;background:#0f131a;color:#e5e7eb;
    font-weight:900;font-size:clamp(20px,6vw,30px);letter-spacing:1px;box-shadow:0 6px 18px rgba(0,0,0,.35);-webkit-tap-highlight-color:transparent;cursor:pointer}
  #tapBtn[disabled]{opacity:.45;filter:saturate(.4);cursor:not-allowed}
  .bar{width:100%;max-width:820px;display:flex;justify-content:center;gap:8px;flex-wrap:nowrap;margin-top:2px} /* ‚Üê TAP„Å´Ëøë„Å•„Åë */
  .btn{border:1px solid #26303a;background:#1f2937;color:var(--fg);border-radius:14px;padding:12px 18px;font-weight:900;cursor:pointer;-webkit-tap-highlight-color:transparent}
  #startBtn{background:linear-gradient(180deg,#34d399,#10b981);border-color:#065f46;color:#062e26;box-shadow:0 10px 28px rgba(16,185,129,.35);
    font-size:clamp(18px,5vw,22px);padding:14px 24px;letter-spacing:.04em}
  .icon-btn{width:56px;height:56px;padding:0;display:inline-flex;align-items:center;justify-content:center;font-size:26px;border-radius:14px}
  #persecutionWrap{width:100%;max-width:820px;display:flex;justify-content:center;margin-top:2px} /* ‚Üê ‰∏äÂØÑ„Åõ */
  #persecutionBtn{display:none;background:linear-gradient(180deg,#f87171,#ef4444);border-color:#7f1d1d;color:#1b0a0a;
    box-shadow:0 10px 28px rgba(239,68,68,.35);font-size:clamp(16px,4.5vw,20px);padding:12px 22px;border-radius:14px}
  dialog{border:none;border-radius:14px;padding:0;max-width:520px;width:90vw;background:#0f131a;color:#fff}
  .dlg-head{padding:14px 16px;border-bottom:1px solid #253040;font-weight:700}
  .dlg-body{padding:12px 16px}
  .rank-list{width:100%;border-collapse:collapse}
  .rank-list th,.rank-list td{padding:8px 6px;border-bottom:1px solid #1d2533;text-align:left}
  .rank-list th{color:#aab4bf;font-weight:600}
  .celebrate{position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:4;display:none}
  .celebrate.show{display:block}
  .con{position:absolute;width:8px;height:14px;opacity:.9;border-radius:2px;animation:fall linear forwards}
  @keyframes fall{0%{transform:translateY(-10vh) rotate(0deg)}100%{transform:translateY(110vh) rotate(720deg)}}
</style>
</head>
<body>
  <header class="title"><h1>„Çπ„Ç≠„É´„ÉÅ„Çß„ÉÉ„ÇØ„Ç≤„Éº„É†</h1></header>

  <div class="wrap">
    <div class="board" id="board">
      <canvas id="cv"></canvas>
      <div id="welcome" class="welcome"><h2>ÁõÆÊåá„Åõ 50ÈÄ£Á∂öÔºÅ</h2></div>
      <div id="overlay" class="overlay"></div>
      <div id="celebrate" class="celebrate"></div>
    </div>

    <div class="tap-row"><button id="tapBtn" aria-label="Tap to stop" disabled>TAP</button></div>

    <div class="bar">
      <button id="startBtn" class="btn">‚ñ∂ „Çπ„Çø„Éº„Éà</button>
      <button id="muteBtn"  class="btn icon-btn" aria-label="„Éü„É•„Éº„ÉàÂàáÊõø">üîä</button>
      <button id="rankBtn"  class="btn icon-btn" aria-label="„É©„É≥„Ç≠„É≥„Ç∞">üèÜ</button>
    </div>
    <div id="persecutionWrap"><button id="persecutionBtn" class="btn">‚ö† Ëø´ÂÆ≥„É¢„Éº„Éâ</button></div>
  </div>

  <dialog id="rankDlg">
    <div class="dlg-head">üèÜ „Ç™„Éï„É©„Ç§„É≥ TOP5</div>
    <div class="dlg-body">
      <table class="rank-list" id="rankTable"><thead><tr><th>#</th><th>Êó•‰ªò</th><th>ÈÄ£Á∂öÂõûÊï∞</th></tr></thead><tbody></tbody></table>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px"><button id="closeRank" class="btn">Èñâ„Åò„Çã</button></div>
    </div>
  </dialog>

<script>
(() => {
  // ===== Ë®≠ÂÆö =====
  const CONFIG = {
    RPM: 60,
    INPUT_CD_MS: 45,
    NEXT_MIN_DEG: 180,
    NEXT_MAX_DEG: 220,
    COUNTDOWN_MS: 1500,
    TARGET_STREAK: 50,
    NORMAL_ZONE: 0.10,
    PERSECUTE_ZONE: 0.06,   // Ëø´ÂÆ≥„É¢„Éº„Éâ„ÅØ0.06
    HIT_EPSILON_DEG: 1.5
  };

  const $=(id)=>document.getElementById(id);
  const board=$('board'), cv=$('cv'), ctx=cv.getContext('2d',{alpha:false,desynchronized:true});
  const tapBtn=$('tapBtn'), startBtn=$('startBtn'), muteBtn=$('muteBtn'), rankBtn=$('rankBtn'), persecutionBtn=$('persecutionBtn');
  const overlay=$('overlay'), welcome=$('welcome'), rankDlg=$('rankDlg'), rankTbd=document.querySelector('#rankTable tbody');
  const closeRank=$('closeRank'), celebrateBox=$('celebrate');

  let phase='idle', streak=0, lastInputAt=0, rafId=0, isMuted=false;
  let mode='normal', currentZoneRatio=CONFIG.NORMAL_ZONE;
  const FULL=Math.PI*2;
  const zoneSize=()=>FULL*currentZoneRatio;
  let baseAngle=0, baseTime=0, frozenAngle=0, zoneStart=0;
  let lastAngle=null, lastInside=false;

  let cssW=0, cssH=0, dpr=1;
  function ensureSquare(){ const bw=board.clientWidth||board.getBoundingClientRect().width||300; board.style.height=bw+'px'; }
  function resizeCanvas(){
    ensureSquare();
    const rect=cv.getBoundingClientRect(); dpr=Math.max(1,Math.min(3,window.devicePixelRatio||1));
    cssW=rect.width||300; cssH=rect.height||300;
    cv.width=Math.round(cssW*dpr); cv.height=Math.round(cssH*dpr); ctx.setTransform(dpr,0,0,dpr,0,0);
    draw(getCurrentAngle(performance.now()));
  }
  window.addEventListener('resize', resizeCanvas);
  if(window.ResizeObserver){ try{ new ResizeObserver(()=>resizeCanvas()).observe(board);}catch{} }
  requestAnimationFrame(resizeCanvas);

  document.addEventListener('touchmove',(e)=>e.preventDefault(),{passive:false});
  ['gesturestart','gesturechange','gestureend','dblclick'].forEach(ev=>document.addEventListener(ev,(e)=>e.preventDefault(),{passive:false}));

  // ===== WebAudioÁï•ÔºàÁúÅÁï•:ÂâçÂõû„ÅÆ„Åæ„ÅæÔºâ =====
  const AudioCtx=window.AudioContext||window.webkitAudioContext;
  let actx,gMaster,buf={success:null,bomb:null,ready:null,fanfare:null}, html={};
  function setupHtmlFallback(){ ['success','bomb','ready','fanfare'].forEach(k=>{ const a=new Audio(`${k}.mp3`); a.preload='auto'; a.playsInline=true; html[k]=a; }); }
  setupHtmlFallback();
  async function unlockAndWarmAudio(){ if(!actx){ actx=new AudioCtx({latencyHint:'interactive'}); gMaster=actx.createGain(); gMaster.connect(actx.destination);} if(actx.state==='suspended') await actx.resume(); }
  function setMuted(m){ isMuted=m; if(gMaster) gMaster.gain.value=m?0:1; Object.values(html).forEach(a=>a.muted=m); muteBtn.textContent=m?'üîá':'üîä'; }
  async function playSE(k){ if(isMuted) return; try{ html[k].currentTime=0; await html[k].play(); }catch{} }
  window.addEventListener('pointerdown',()=>unlockAndWarmAudio(),{once:true});

  const norm=a=>(a%FULL+FULL)%FULL;
  const inRange=(a,s,e)=>(s<=e)?(a>=s&&a<=e):(a>=s||a<=e);
  const cwDelta=(from,to)=>(to-from+FULL)%FULL;
  const angleAt=(t)=>{ const rps=CONFIG.RPM/60; const d=(t-baseTime)/1000; return norm(baseAngle+rps*FULL*d); };
  const getCurrentAngle=(t)=>(phase==='play')?angleAt(t):frozenAngle;

  function draw(angle){
    const w=cssW,h=cssH,CX=w/2,CY=h/2;
    const r=Math.min(w,h)*0.378;   // ÂÜÜ„Çµ„Ç§„Ç∫„Çí0.9ÂÄç
    const ZS=zoneSize();
    ctx.clearRect(0,0,w,h);
    ctx.beginPath(); ctx.arc(CX,CY,r,0,FULL); ctx.lineWidth=2; ctx.strokeStyle='#1a2330'; ctx.stroke();
    ctx.beginPath(); ctx.lineWidth=24; ctx.strokeStyle='#ffffff'; ctx.arc(CX,CY,r,zoneStart,zoneStart+ZS); ctx.stroke();
    const front=r*1.2,back=r*0.2;
    const fx=CX+front*Math.cos(angle),fy=CY+front*Math.sin(angle);
    const bx=CX-back*Math.cos(angle),by=CY-back*Math.sin(angle);
    ctx.beginPath(); ctx.moveTo(bx,by); ctx.lineTo(fx,fy); ctx.lineWidth=6; ctx.strokeStyle='#ef4444'; ctx.stroke();
    const combo=String(streak);
    ctx.save(); ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font=`900 ${Math.max(18,Math.round(r*0.32))}px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif`;
    ctx.lineWidth=Math.max(2,Math.round(r*0.04)); ctx.strokeStyle='rgba(0,0,0,0.55)'; ctx.strokeText(combo,CX,CY-r*0.18);
    ctx.fillStyle='#eaeef2'; ctx.fillText(combo,CX,CY-r*0.18);
    ctx.restore();
  }

  // ‰ª•Èôç„ÅØÂâçÂõû„Ç≥„Éº„Éâ„Å®Âêå„ÅòÔºàÁúÅÁï•Ôºâ
})();
</script>
</body>
</html>
