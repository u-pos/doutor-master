<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>DBDã‚¹ã‚­ãƒ«ãƒã‚§ãƒƒã‚¯ï¼šæ€’æ¶›ã®åµï¼ˆåŸºæº–çµ±ä¸€ãƒ»å®Œå…¨ä¿®æ­£ï¼‰</title>
<style>
  :root{ --bg:#0f1115; --fg:#eaeef2; --muted:#9aa4af; }
  html,body{
    margin:0;height:100%;
    background:var(--bg);color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    touch-action:manipulation; -webkit-user-select:none; user-select:none; -webkit-touch-callout:none;
  }
  .wrap{min-height:100dvh;display:flex;flex-direction:column;align-items:center;gap:12px;padding:12px}
  .board{width:100%;max-width:720px;aspect-ratio:1/1;position:relative}
  canvas{width:100%;height:100%;display:block;border-radius:16px;background:#0b0e13;touch-action:none}
  .overlay{
    position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:2;
    font-weight:900;font-size:clamp(28px,8vw,56px);background:rgba(0,0,0,.25);backdrop-filter:saturate(120%) blur(1px);
  }
  .overlay.show{display:flex}

  .tap-row{width:100%;max-width:720px;margin-top:10px;display:flex;justify-content:center}
  #tapBtn{
    width:min(92%,560px);height:72px;border-radius:16px;border:2px solid #334155;background:#0f131a;color:#e5e7eb;
    font-weight:900;font-size:clamp(18px,5vw,28px);letter-spacing:1px;box-shadow:0 6px 18px rgba(0,0,0,.35);
    user-select:none;-webkit-tap-highlight-color:transparent; touch-action:manipulation; cursor:pointer;
  }
  #tapBtn[disabled]{opacity:.45;filter:saturate(.4);cursor:not-allowed}

  .bottombar{margin-top:10px;width:100%;max-width:720px;display:flex;justify-content:center;gap:8px}
  .btn{
    border:1px solid #26303a;background:#1f2937;color:var(--fg);border-radius:12px;padding:10px 16px;
    font-weight:800;cursor:pointer;touch-action:manipulation;-webkit-tap-highlight-color:transparent
  }
  .btn.warn{background:#3a2b12;border-color:#8a5a12;color:#fde68a}
  .btn.alt{background:#122031;border-color:#2a3f59}

  dialog{border:none;border-radius:14px;padding:0;max-width:520px;width:90vw;background:#0f131a;color:var(--fg)}
  .dlg-head{padding:14px 16px;border-bottom:1px solid #253040;font-weight:700}
  .dlg-body{padding:12px 16px}
  .rank-list{width:100%;border-collapse:collapse}
  .rank-list th,.rank-list td{padding:8px 6px;border-bottom:1px solid #1d2533;text-align:left}
  .rank-list th{color:#aab4bf;font-weight:600}
  .hint{font-size:12px;color:var(--muted);text-align:center;margin-top:4px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="board">
      <canvas id="cv"></canvas>
      <div id="overlay" class="overlay"></div>
    </div>

    <div class="tap-row">
      <button id="tapBtn" aria-label="Tap to stop" disabled>TAP</button>
    </div>

    <div class="bottombar">
      <button id="startBtn" class="btn">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <button id="pauseBtn" class="btn warn">â¸ ä¸€æ™‚åœæ­¢</button>
      <button id="rankBtn"  class="btn alt">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
    </div>

    <div class="hint">æˆåŠŸ: <code>success.mp3</code>ï¼å¤±æ•—: <code>bomb.mp3</code></div>
  </div>

  <dialog id="rankDlg">
    <div class="dlg-head">ğŸ† ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ TOP5</div>
    <div class="dlg-body">
      <table class="rank-list" id="rankTable">
        <thead><tr><th>#</th><th>æ—¥ä»˜</th><th>é€£ç¶šå›æ•°</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
        <button id="closeRank" class="btn">é–‰ã˜ã‚‹</button>
        <button id="resetRank" class="btn warn">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>
  </dialog>

<script>
(() => {
  // ===== å›ºå®šè¨­å®š =====
  const CONFIG = {
    RPM: 60,                 // ä¸€å®šé€Ÿåº¦
    ZONE_RATIO: 0.08,        // ç™½ã‚¾ãƒ¼ãƒ³è§’åº¦å¹…ï¼ˆå††å‘¨æ¯”ï¼‰
    INPUT_CD_MS: 45,         // èª¤çˆ†é˜²æ­¢
    NEXT_MIN_DEG: 180,       // æˆåŠŸå¾Œï¼šæˆåŠŸè§’ + [180Â°,220Â°] ã«æ¬¡ã‚¾ãƒ¼ãƒ³ä¸­å¿ƒ
    NEXT_MAX_DEG: 220,
    COUNTDOWN_MS: 1500       // Readyâ†’GOï¼ˆé‡ã¯æ­¢ã‚ã‚‹ï¼‰
  };

  // ===== è¦ç´  =====
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d', {alpha:false, desynchronized:true});
  const tapBtn  = document.getElementById('tapBtn');
  const startBtn= document.getElementById('startBtn');
  const pauseBtn= document.getElementById('pauseBtn');
  const rankBtn = document.getElementById('rankBtn');
  const overlay = document.getElementById('overlay');
  const rankDlg = document.getElementById('rankDlg');
  const rankTbd = document.querySelector('#rankTable tbody');
  const closeRank = document.getElementById('closeRank');
  const resetRank = document.getElementById('resetRank');

  // ===== çŠ¶æ…‹ =====
  let phase = 'idle'; // idle | countdown | play
  let paused = false;
  let streak = 0;
  let lastInputAt = 0;
  let rafId = 0;

  const FULL = Math.PI * 2;
  const ZONE_SIZE = FULL * CONFIG.ZONE_RATIO;

  // å›è»¢ã¯ baseAngle@baseTimeï¼ˆcanvasæ¨™æº–ï¼š0rad=å³ã€åæ™‚è¨ˆå›ã‚Šï¼‰
  let baseAngle = 0;
  let baseTime  = 0;
  // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ä¸­ã®å›ºå®šè§’
  let frozenAngle = 0;

  // ç™½ã‚¾ãƒ¼ãƒ³
  let zoneStart = 0; // é–‹å§‹è§’
  const zoneCenter = () => norm(zoneStart + ZONE_SIZE/2);

  // é€šéãƒŸã‚¹ç›£è¦–
  let lastAngle = null;
  let lastInside = false;

  // DPR & ãƒªã‚µã‚¤ã‚º
  let cssW=0, cssH=0, dpr=1;
  function resizeCanvas(){
    const rect = cv.getBoundingClientRect();
    dpr = Math.max(1, Math.min(3, window.devicePixelRatio||1));
    cssW = rect.width; cssH = rect.height;
    cv.width  = Math.round(cssW * dpr);
    cv.height = Math.round(cssH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    draw(getCurrentAngle(performance.now()));
  }
  new ResizeObserver(resizeCanvas).observe(cv);

  // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª
  const successAudio = new Audio('success.mp3');
  const bombAudio    = new Audio('bomb.mp3');
  [successAudio, bombAudio].forEach(a=>{ a.preload='auto'; a.volume=0.9; });
  const warm=a=>a.play().then(()=>{a.pause();a.currentTime=0;}).catch(()=>{});
  window.addEventListener('pointerdown', function unlock(){ warm(successAudio); warm(bombAudio); window.removeEventListener('pointerdown', unlock); }, {once:true});

  // iOSã®ã‚ºãƒ¼ãƒ æŠ‘æ­¢
  document.addEventListener('dblclick', e=>e.preventDefault(), {passive:false});
  ['gesturestart','gesturechange','gestureend'].forEach(ev=> window.addEventListener(ev, e=>e.preventDefault(), {passive:false}));

  // è§’åº¦ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆcanvasæ¨™æº–ï¼š0=å³ã€åæ™‚è¨ˆå›ã‚Šï¼‰
  const norm = a => (a % FULL + FULL) % FULL;
  const inRange = (a,s,e)=> (s<=e) ? (a>=s && a<=e) : (a>=s || a<=e);
  const cwDelta = (from,to)=> (to - from + FULL) % FULL; // æ™‚è¨ˆå›ã‚Šã§ã®è·é›¢ï¼ˆé€šéæ¤œå‡ºç”¨ã ãŒåŸºæº–çµ±ä¸€ï¼‰

  const angleAt = (t) => {
    const rps = CONFIG.RPM / 60;
    const delta = (t - baseTime)/1000;
    return norm(baseAngle + rps * FULL * delta);
  };
  const getCurrentAngle = (t) => (phase==='play') ? angleAt(t) : frozenAngle;

  // æç”»ï¼ˆé‡ã¯cos/sinã§åº§æ¨™ç›´æç”»ã€‚å›è»¢è¡Œåˆ—ã¯ä¸€åˆ‡ä½¿ã‚ãªã„ â†’ åŸºæº–ã‚ºãƒ¬ã‚’æ ¹çµ¶ï¼‰
  function draw(angle){
    const w = cssW, h = cssH;
    const CX = w/2, CY = h/2;
    const r  = Math.min(w,h)*0.42;

    ctx.clearRect(0,0,w,h);

    // å¤–æ 2px
    ctx.beginPath(); ctx.arc(CX, CY, r, 0, FULL);
    ctx.lineWidth = 2; ctx.strokeStyle = '#1a2330'; ctx.stroke();

    // ç™½ã‚¾ãƒ¼ãƒ³
    ctx.beginPath(); ctx.lineWidth = 24; ctx.strokeStyle = '#ffffff';
    ctx.arc(CX, CY, r, zoneStart, zoneStart + ZONE_SIZE); ctx.stroke();

    // èµ¤é‡ï¼ˆåŠå¾„ã‚ˆã‚Šã¡ã‚‡ã„é•·ï¼šå‰1.2Rï¼å¾Œ0.2Rï¼‰
    const front = r * 1.2, back = r * 0.2;
    const fx = CX + front * Math.cos(angle);
    const fy = CY + front * Math.sin(angle);
    const bx = CX - back  * Math.cos(angle);
    const by = CY - back  * Math.sin(angle);
    ctx.beginPath();
    ctx.moveTo(bx, by); ctx.lineTo(fx, fy);
    ctx.lineWidth = 6; ctx.strokeStyle = '#ef4444'; ctx.stroke();
  }

  // ãƒ«ãƒ¼ãƒ—
  function loop(now){
    const ang = getCurrentAngle(now);
    draw(ang);

    if(phase==='play' && !paused){
      // é€šéã—åˆ‡ã‚Šã®ãƒŸã‚¹æ¤œå‡ºï¼ˆã‚¾ãƒ¼ãƒ³çµ‚ç«¯è¶…ãˆï¼‰
      const zoneEnd = norm(zoneStart + ZONE_SIZE);
      const inside  = inRange(ang, zoneStart, zoneEnd);
      if(lastAngle !== null){
        if(lastInside && !inside){
          const moved = cwDelta(lastAngle, ang);
          const toEnd = cwDelta(lastAngle, zoneEnd);
          if(moved >= toEnd){ return gameOver(); }
        }
      }
      lastInside = inside;
      lastAngle  = ang;
    }

    rafId = requestAnimationFrame(loop);
  }

  // åˆæœŸé…ç½®ï¼šã‚¾ãƒ¼ãƒ³ä¸­å¿ƒã‚’ãƒ©ãƒ³ãƒ€ãƒ â†’é‡ã¯ãã®çœŸåå¯¾
  function setupInitial(){
    const center = Math.random()*FULL;
    zoneStart    = norm(center - ZONE_SIZE/2);
    frozenAngle  = norm(center + Math.PI); // â˜…çœŸåå¯¾ï¼ˆcanvasæ¨™æº–è§’åº¦ç³»ã§ãã®ã¾ã¾ï¼‰
    lastInside = false; lastAngle = null;
  }

  // æˆåŠŸå¾Œï¼šæ¬¡ã‚¾ãƒ¼ãƒ³ä¸­å¿ƒ = æˆåŠŸè§’ + [180Â°,220Â°]
  function moveZoneAfterSuccess(successAngle){
    const min = CONFIG.NEXT_MIN_DEG * Math.PI/180;
    const max = CONFIG.NEXT_MAX_DEG * Math.PI/180;
    const nextCenter = norm(successAngle + (min + Math.random()*(max-min)));
    zoneStart = norm(nextCenter - ZONE_SIZE/2);
    lastInside = false; lastAngle = null;
  }

  // å…¥åŠ›
  function onTap(){
    if(phase!=='play' || paused) return;
    const now = performance.now();
    if(now - lastInputAt < CONFIG.INPUT_CD_MS) return;
    lastInputAt = now;

    const a  = angleAt(now);
    const ok = inRange(a, zoneStart, norm(zoneStart + ZONE_SIZE));
    if(ok){
      try{ successAudio.currentTime=0; successAudio.play().catch(()=>{});}catch{}
      streak++;
      baseAngle = a; baseTime = now;  // å†…éƒ¨åŸºæº–ã‚’ç¾åœ¨è§’ã«åˆã‚ã›ã‚‹
      moveZoneAfterSuccess(a);
      draw(a);
    }else{
      gameOver();
    }
  }

  // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ï¼ˆé‡ã¯åœæ­¢è§’ã®ã¾ã¾è¡¨ç¤ºã€TAPç„¡åŠ¹ï¼‰
  function showCountdown(){
    overlay.classList.add('show');
    overlay.textContent = 'Ready';
    tapBtn.disabled = true;
    phase = 'countdown';

    const t0 = performance.now();
    const mid = t0 + CONFIG.COUNTDOWN_MS * 0.6;
    const end = t0 + CONFIG.COUNTDOWN_MS;

    const tick = () => {
      const now = performance.now();
      if(now >= end){
        overlay.classList.remove('show');
        // GO â†’ å›è»¢é–‹å§‹ï¼ˆé‡ã¯ä»Šã®åœæ­¢è§’ï¼ã‚¾ãƒ¼ãƒ³åå¯¾å´ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆï¼‰
        baseAngle = frozenAngle;
        baseTime  = now;
        phase = 'play';
        tapBtn.disabled = false;
        // ç›£è¦–åˆæœŸåŒ–
        const ang = angleAt(now);
        lastAngle  = ang;
        lastInside = inRange(ang, zoneStart, norm(zoneStart + ZONE_SIZE));
        return;
      }
      if(now >= mid) overlay.textContent = 'GO!';
      requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);
  }

  // åˆ¶å¾¡
  function startGame(){
    if(rafId) cancelAnimationFrame(rafId);
    paused=false; streak=0;
    setupInitial();          // â˜…ã“ã“ã§ã‚¾ãƒ¼ãƒ³ã¨é‡ï¼ˆçœŸåå¯¾ï¼‰ã‚’æ±ºå®š
    resizeCanvas();          // ã™ãåæ˜ ï¼ˆã“ã®æ™‚ç‚¹ã§ã‚‚é‡ã¯åå¯¾å´ï¼‰
    showCountdown();         // Readyâ†’GOä¸­ã¯å‡çµè§’ã®ã¾ã¾
    rafId = requestAnimationFrame(loop);
  }
  function pauseGame(){
    if(phase!=='play') return;
    paused = !paused;
    pauseBtn.textContent = paused ? 'â–¶ å†é–‹' : 'â¸ ä¸€æ™‚åœæ­¢';
    if(!paused){
      const now = performance.now();
      const a = angleAt(now);
      baseAngle = a; baseTime = now; // å†é–‹æ™‚ã«ã‚ºãƒ¬ãªã„ã‚ˆã†æƒãˆã‚‹
      draw(a);
    }
  }
  function gameOver(){
    try{ bombAudio.currentTime=0; bombAudio.play().catch(()=>{});}catch{}
    phase='idle'; tapBtn.disabled=true;
    if(rafId) cancelAnimationFrame(rafId);
    saveScore({score:streak, at:Date.now()});
    renderRanking();
  }

  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«TOP5ï¼‰
  const KEY='skillcheck_top5_fixed_v4';
  const loadScores=()=>{ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch{return []} };
  function saveScore(e){
    if(e.score<=0) return;
    const arr=loadScores(); arr.push(e);
    arr.sort((a,b)=> b.score-a.score || b.at-a.at);
    localStorage.setItem(KEY, JSON.stringify(arr.slice(0,5)));
  }
  function renderRanking(){
    const arr = loadScores(); rankTbd.innerHTML='';
    arr.forEach((e,i)=>{
      const dt=new Date(e.at);
      const d=`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${i+1}</td><td>${d}</td><td>${e.score}</td>`;
      rankTbd.appendChild(tr);
    });
  }
  function resetRanking(){ localStorage.removeItem(KEY); renderRanking(); }

  // ã‚¤ãƒ™ãƒ³ãƒˆ
  startBtn.addEventListener('click', (e)=>{ e.preventDefault(); startGame(); }, {passive:false});
  pauseBtn.addEventListener('click', (e)=>{ e.preventDefault(); pauseGame(); }, {passive:false});
  rankBtn .addEventListener('click', (e)=>{ e.preventDefault(); renderRanking(); rankDlg.showModal(); }, {passive:false});
  closeRank.addEventListener('click', (e)=>{ e.preventDefault(); rankDlg.close(); }, {passive:false});
  resetRank.addEventListener('click', (e)=>{ e.preventDefault(); if(confirm('ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) resetRanking(); }, {passive:false});

  tapBtn.addEventListener('pointerdown', (e)=>{ e.preventDefault(); onTap(); }, {passive:false});
  window.addEventListener('keydown', (e)=>{ if(e.code==='Space'){ e.preventDefault(); onTap(); } });

  // åˆæœŸ
  renderRanking();
  requestAnimationFrame(resizeCanvas);
})();
</script>
</body>
</html>
