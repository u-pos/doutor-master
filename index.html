<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>DBDスキルチェック：怒涛の嵐 連続チャレンジ</title>
<style>
  :root{
    --bg:#0f1115; --fg:#eaeef2; --muted:#9aa4af; --accent:#4ade80; --warn:#f59e0b; --danger:#ef4444;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{min-height:100%;display:flex;flex-direction:column;align-items:center;gap:12px;padding:12px}
  .topbar{width:100%;max-width:680px;display:flex;justify-content:space-between;align-items:center;gap:8px}
  .title{font-weight:700;font-size:clamp(16px,2.8vw,22px)}
  .stats{display:flex;gap:10px;font-weight:600}
  .btns{display:flex;gap:8px}
  button{
    border:1px solid #26303a;background:#161a21;color:var(--fg);border-radius:10px;
    padding:10px 12px;font-weight:700;cursor:pointer;touch-action:manipulation
  }
  button:active{transform:translateY(1px)}
  button.primary{background:#1f2937;border-color:#334155}
  button.accent{background:#12331c;border-color:#1f6d39;color:#bbf7d0}
  button.warn{background:#3a2b12;border-color:#8a5a12;color:#fde68a}
  button.danger{background:#3a1515;border-color:#7f1d1d;color:#fecaca}
  .board{width:100%;max-width:680px;aspect-ratio:1/1;position:relative}
  canvas{width:100%;height:100%;display:block;border-radius:16px;background:#0b0e13}
  /* 画面中央のTAPボタン */
  .tap-btn{
    position:absolute;inset:auto;left:50%;top:50%;transform:translate(-50%,-50%);
    width:min(46%,220px);height:min(46%,220px);border-radius:9999px;
    display:flex;align-items:center;justify-content:center;
    border:3px solid #334155;background:#0f131a;color:#e5e7eb;font-weight:900;
    font-size:clamp(18px,6vw,28px);letter-spacing:1px;
    box-shadow:0 6px 18px rgba(0,0,0,.4);
    user-select:none; -webkit-tap-highlight-color:transparent;
  }
  .tap-btn:active{transform:translate(-50%,-50%) scale(0.98)}
  .hint{font-size:14px;color:var(--muted);text-align:center}
  .footer{margin-top:auto;font-size:12px;color:var(--muted)}
  dialog{
    border:none;border-radius:14px;padding:0;max-width:520px;width:90vw;background:#0f131a;color:var(--fg)
  }
  .dlg-head{padding:14px 16px;border-bottom:1px solid #253040;font-weight:700}
  .dlg-body{padding:12px 16px}
  .rank-list{width:100%;border-collapse:collapse}
  .rank-list th,.rank-list td{padding:8px 6px;border-bottom:1px solid #1d2533;text-align:left}
  .rank-list th{color:#aab4bf;font-weight:600}
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">DBDスキルチェック：怒涛の嵐 連続チャレンジ</div>
      <div class="btns">
        <button id="startBtn" class="primary">▶ スタート</button>
        <button id="pauseBtn" class="warn">⏸ 一時停止</button>
        <button id="muteBtn">🔈 ミュート</button>
        <button id="rankBtn" class="accent">🏆 ランキング</button>
      </div>
    </div>

    <div class="topbar" style="margin-top:-6px">
      <div class="stats">
        <div>連続成功: <span id="streak">0</span></div>
        <div>ベスト: <span id="best">0</span></div>
        <div>速度: <span id="speed">1.0x</span></div>
      </div>
      <div class="hint">中央の「TAP」かスペースキーで判定。Good/Greatゾーンは本家風の幅やで。</div>
    </div>

    <div class="board">
      <canvas id="cv"></canvas>
      <button id="tapBtn" class="tap-btn" aria-label="Tap to check">TAP</button>
    </div>

    <div class="footer">※ 成功時に <code>success.mp3</code> を再生（初回タップで再生権限を解放）。</div>
  </div>

  <dialog id="rankDlg">
    <div class="dlg-head">🏆 オフライン TOP5</div>
    <div class="dlg-body">
      <table class="rank-list" id="rankTable">
        <thead><tr><th>#</th><th>日付</th><th>連続回数</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
        <button id="closeRank">閉じる</button>
        <button id="resetRank" class="danger">リセット</button>
      </div>
    </div>
  </dialog>

<script>
(() => {
  // ====== 調整パラメータ（DBD風幅の近似）======
  const CONFIG = {
    goodArcRatio: 0.18,   // 円周に対するGood成功ゾーン比率（約18%）
    greatArcRatio: 0.04,  // Good内に含まれるGreatゾーン（約4%）
    baseRPM: 60,          // 初期回転スピード（RPM）
    rpmIncrease: 6,       // 成功ごとのRPM増加
    maxRPM: 180,          // 上限
    pointerWidth: 6,      // ポインタ太さ（px）
    inputCooldownMs: 250
  };

  // ====== 要素 ======
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');
  const tapBtn  = document.getElementById('tapBtn');
  const startBtn= document.getElementById('startBtn');
  const pauseBtn= document.getElementById('pauseBtn');
  const muteBtn = document.getElementById('muteBtn');
  const rankBtn = document.getElementById('rankBtn');
  const rankDlg = document.getElementById('rankDlg');
  const rankTbd = document.querySelector('#rankTable tbody');
  const closeRank = document.getElementById('closeRank');
  const resetRank = document.getElementById('resetRank');

  const elStreak = document.getElementById('streak');
  const elBest   = document.getElementById('best');
  const elSpeed  = document.getElementById('speed');

  // ====== 状態 ======
  let running=false, paused=false, muted=false;
  let lastInputAt=0, lastTs=0;
  let angle=0; // rad
  let rpm = CONFIG.baseRPM;
  let zoneStart=0;
  let zoneSize = Math.PI*2*CONFIG.goodArcRatio;
  let greatSize= Math.PI*2*CONFIG.greatArcRatio;
  let streak=0, best=loadBest()||0;

  // DPR対応：CSSピクセル基準で描く
  let cssW=0, cssH=0;
  function resizeCanvas(){
    const rect = cv.getBoundingClientRect();
    const dpr = Math.max(1, Math.min(3, window.devicePixelRatio||1));
    cssW = rect.width; cssH = rect.height;
    cv.width  = Math.round(cssW * dpr);
    cv.height = Math.round(cssH * dpr);
    // ここが重要：描画はCSS座標で行う → 変換だけdprに
    ctx.setTransform(dpr,0,0,dpr,0,0);
    draw();
  }
  new ResizeObserver(resizeCanvas).observe(cv);

  // ====== オーディオ ======
  const successAudio = new Audio('success.mp3');
  successAudio.preload='auto'; successAudio.volume=0.9;
  function unlockAudio(){ successAudio.play().then(()=>{successAudio.pause();successAudio.currentTime=0;}).catch(()=>{}); window.removeEventListener('pointerdown',unlockAudio,{once:true}); }
  window.addEventListener('pointerdown', unlockAudio, {once:true});

  // ====== 描画 ======
  function draw(){
    const w = cssW, h = cssH;
    const CX = w/2, CY = h/2;
    const rOuter = Math.min(w,h)*0.42;
    const rInner = rOuter - 36;

    ctx.clearRect(0,0,w,h);

    // 背景円
    ctx.beginPath(); ctx.arc(CX, CY, rOuter+24, 0, Math.PI*2);
    ctx.fillStyle = '#0a0d12'; ctx.fill();

    // リング
    ctx.beginPath(); ctx.arc(CX, CY, rOuter, 0, Math.PI*2);
    ctx.lineWidth = 24; ctx.strokeStyle = '#1a2330'; ctx.stroke();

    // Goodゾーン
    ctx.beginPath();
    ctx.strokeStyle = '#1f9d55'; ctx.lineWidth = 24;
    ctx.arc(CX, CY, rOuter, zoneStart, zoneStart+zoneSize); ctx.stroke();

    // Greatゾーン
    const greatStart = zoneStart + (zoneSize - greatSize)/2;
    ctx.beginPath();
    ctx.strokeStyle = '#fbbf24'; ctx.lineWidth = 24;
    ctx.arc(CX, CY, rOuter, greatStart, greatStart+greatSize); ctx.stroke();

    // 目盛り
    ctx.save(); ctx.translate(CX, CY);
    const ticks = 32;
    for(let i=0;i<ticks;i++){
      const a = i*(Math.PI*2/ticks);
      const x1 = Math.cos(a)*(rInner-10), y1 = Math.sin(a)*(rInner-10);
      const x2 = Math.cos(a)*(rInner-2),  y2 = Math.sin(a)*(rInner-2);
      ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2);
      ctx.strokeStyle = '#263146'; ctx.lineWidth = 2; ctx.stroke();
    }
    ctx.restore();

    // ポインタ
    ctx.save(); ctx.translate(CX, CY); ctx.rotate(angle);
    ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0, -rInner);
    ctx.lineWidth = CONFIG.pointerWidth; ctx.strokeStyle = '#e5e7eb';
    ctx.shadowColor = '#93c5fd'; ctx.shadowBlur = 8; ctx.stroke();
    ctx.restore();

    // 中央ラベル
    ctx.fillStyle = '#9aa4af';
    ctx.font = '700 28px system-ui, -apple-system, Segoe UI';
    ctx.textAlign = 'center';
    ctx.fillText(`怒涛の嵐 連続 ${streak}`, CX, CY+10);
  }

  // ====== ゾーン関連 ======
  function randomizeZone(){
    const full = Math.PI*2;
    const pad = 0.15;
    zoneStart = (Math.random()*full + (Math.random()*pad - pad/2)) % full;
  }

  // ====== HUD ======
  function updateHUD(){
    elStreak.textContent = String(streak);
    elBest.textContent   = String(best);
    const speedX = (rpm / CONFIG.baseRPM).toFixed(1);
    elSpeed.textContent  = `${speedX}x`;
  }

  // ====== ループ ======
  function loop(ts){
    if(!running){ return; }
    if(paused){ requestAnimationFrame(loop); return; }
    if(!lastTs) lastTs = ts;
    const dt = (ts - lastTs)/1000; lastTs = ts;

    const rps = rpm / 60;
    angle = (angle + rps * Math.PI*2 * dt) % (Math.PI*2);

    draw();
    requestAnimationFrame(loop);
  }

  // ====== 入力 ======
  function tryCheck(){
    const now = performance.now();
    if(now - lastInputAt < CONFIG.inputCooldownMs) return;
    lastInputAt = now;
    if(!running) return;

    const a = norm(angle);
    const s = norm(zoneStart);
    const e = norm(zoneStart + zoneSize);
    const ok = inRange(a, s, e);

    if(ok){
      playSuccess();
      streak++; best = Math.max(best, streak);
      rpm = Math.min(CONFIG.maxRPM, rpm + CONFIG.rpmIncrease);
      randomizeZone();
      updateHUD();
    }else{
      gameOver();
    }
  }
  function norm(a){ const t=Math.PI*2; return (a%t + t) % t; }
  function inRange(a,s,e){ return (s<=e) ? (a>=s && a<=e) : (a>=s || a<=e); }

  // ====== サウンド ======
  function playSuccess(){
    if(muted) return;
    try{ successAudio.currentTime=0; successAudio.play().catch(()=>{}); }catch(_){}
  }

  // ====== ゲーム制御 ======
  function startGame(){
    running=true; paused=false; lastTs=0; angle=0; rpm=CONFIG.baseRPM; streak=0;
    randomizeZone(); updateHUD(); requestAnimationFrame(loop);
  }
  function pauseGame(){
    if(!running) return;
    paused = !paused;
    pauseBtn.textContent = paused ? '▶ 再開' : '⏸ 一時停止';
  }
  function stopGame(){ running=false; paused=false; lastTs=0; }

  function gameOver(){
    stopGame();
    updateHUD();
    saveScore({score:streak, at:Date.now()});
    renderRanking();
  }

  // ====== ランキング（ローカル・名前なし） ======
  const KEY='skillcheck_top5_v2_noname';
  function loadScores(){
    try{ return JSON.parse(localStorage.getItem(KEY)||'[]') }catch{ return [] }
  }
  function saveScore(entry){
    const arr = loadScores();
    if(entry.score>0){ arr.push(entry); }
    arr.sort((a,b)=> b.score - a.score || b.at - a.at);
    const top5 = arr.slice(0,5);
    localStorage.setItem(KEY, JSON.stringify(top5));
    best = Math.max(best, top5[0]?.score||0);
    updateHUD();
  }
  function renderRanking(){
    const arr = loadScores();
    rankTbd.innerHTML='';
    arr.forEach((e,i)=>{
      const dt=new Date(e.at);
      const d=`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${i+1}</td><td>${d}</td><td>${e.score}</td>`;
      rankTbd.appendChild(tr);
    });
  }
  function resetRanking(){ localStorage.removeItem(KEY); renderRanking(); best=0; updateHUD(); }

  // ====== イベント ======
  startBtn.addEventListener('click', startGame);
  pauseBtn.addEventListener('click', pauseGame);
  muteBtn.addEventListener('click', ()=>{ muted=!muted; successAudio.muted=muted; muteBtn.textContent = muted?'🔇 ミュート中':'🔈 ミュート'; });
  rankBtn.addEventListener('click', ()=>{ renderRanking(); rankDlg.showModal(); });
  document.getElementById('closeRank').addEventListener('click', ()=>rankDlg.close());
  resetRank.addEventListener('click', ()=>{ if(confirm('ランキングをリセットするで？')) resetRanking(); });

  // 中央TAP／スペース
  tapBtn.addEventListener('click', tryCheck);
  window.addEventListener('keydown', (e)=>{ if(e.code==='Space'){ e.preventDefault(); tryCheck(); } });

  // 初期化
  renderRanking(); updateHUD(); resizeCanvas();
})();
</script>
</body>
</html>
