<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>„Çπ„Ç≠„É´„ÉÅ„Çß„ÉÉ„ÇØ„Ç≤„Éº„É†</title>
<style>
  body {
    margin: 0;
    font-family: sans-serif;
    background: #111;
    color: #fff;
    text-align: center;
  }
  h1 {
    margin: 10px 0;
    font-size: 24px;
    color: #facc15;
    text-shadow: 2px 2px 4px #000;
  }
  canvas {
    display: block;
    margin: 0 auto;
    background: #111;
    touch-action: none;
  }
  .welcome {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -40%);
    font-size: 28px;
    color: #facc15;
    text-shadow: 2px 2px 4px #000;
    pointer-events: none;
  }
  #combo {
    position: absolute;
    top: 52%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 28px;
    font-weight: bold;
    color: #fff;
    text-shadow: 2px 2px 4px #000;
    pointer-events: none;
  }
  #controls {
    margin-top: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .btn-row {
    display: flex;
    justify-content: center;
    margin: 4px 0;
    gap: 10px;
  }
  button {
    font-size: 16px;
    padding: 10px 18px;
    margin: 5px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
  }
  #tapBtn {
    background: #f43f5e;
    color: #fff;
    width: 160px;
    height: 70px;
    font-size: 24px;
    font-weight: bold;
  }
  #startBtn {
    background: #22c55e;
    color: #fff;
  }
  #persecutionBtn {
    background: #3b82f6;
    color: #fff;
    display: none;
  }
  #muteBtn {
    position: absolute;
    top: 10px;
    left: 10px;
    background: none;
    border: none;
    font-size: 22px;
    color: #fff;
  }
  #explosion {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 240px;
    height: 240px;
    display: none;
    pointer-events: none;
  }
  .ranking-btn {
    background: #eab308;
    color: #000;
    font-weight: bold;
  }
</style>
</head>
<body>
  <h1>„Çπ„Ç≠„É´„ÉÅ„Çß„ÉÉ„ÇØ„Ç≤„Éº„É†</h1>
  <div id="gameArea">
    <canvas id="gameCanvas" width="320" height="320"></canvas>
    <div id="combo"></div>
    <div class="welcome" id="welcome">ÁõÆÊåá„Åõ 50ÈÄ£Á∂öÔºÅ</div>
    <video id="explosion" src="ex.mp4"></video>
  </div>

  <button id="muteBtn">üîá</button>

  <div id="controls">
    <div class="btn-row">
      <button id="tapBtn">TAP</button>
    </div>
    <div class="btn-row">
      <button id="startBtn">„Çπ„Çø„Éº„Éà</button>
      <button id="rankNormalBtn" class="ranking-btn">„É©„É≥„Ç≠„É≥„Ç∞(ÈÄöÂ∏∏)</button>
    </div>
    <div class="btn-row">
      <button id="persecutionBtn">Ëø´ÂÆ≥„É¢„Éº„Éâ</button>
      <button id="rankPersecutionBtn" class="ranking-btn" style="display:none;">„É©„É≥„Ç≠„É≥„Ç∞(Ëø´ÂÆ≥)</button>
    </div>
  </div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const CX = canvas.width/2, CY = canvas.height/2, R = 120;
const CONFIG = {
  RPM: 60,
  NORMAL_ZONE: 0.10,
  PERSECUTE_ZONE: 0.06,
  COUNTDOWN_MS: 1500
};

let angle = 0;
let phase = "idle";
let streak = 0;
let currentZoneRatio = CONFIG.NORMAL_ZONE;
let zoneStart = 0, zoneEnd = 0;
let showInitialNeedle = true;  // ‚Üê ÂàùÊúüÈáùË°®Á§∫„Éï„É©„Ç∞

function randZone() {
  const w = currentZoneRatio * 2*Math.PI;
  const s = Math.random() * 2*Math.PI;
  zoneStart = s;
  zoneEnd = (s+w)%(2*Math.PI);
}
function setupInitial() {
  randZone();
  angle = (zoneStart + (zoneEnd-zoneStart+Math.PI*2)% (2*Math.PI)/2 + Math.PI) % (2*Math.PI);
}
setupInitial();

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.beginPath();
  ctx.arc(CX,CY,R,0,2*Math.PI);
  ctx.lineWidth = 2;
  ctx.strokeStyle = "#888";
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(CX,CY);
  ctx.arc(CX,CY,R,zoneStart,zoneEnd,false);
  ctx.lineTo(CX,CY);
  ctx.fillStyle="white";
  ctx.fill();

  if (phase !== 'explosion' && (phase === 'play' || showInitialNeedle)) {
    ctx.beginPath();
    ctx.moveTo(CX,CY);
    ctx.lineTo(CX + R*1.2*Math.cos(angle), CY + R*1.2*Math.sin(angle));
    ctx.lineWidth=6;
    ctx.strokeStyle="#ef4444";
    ctx.stroke();
  }
}

function loop(ts) {
  if(phase==="play"){
    angle += (2*Math.PI*CONFIG.RPM/60)/60;
    angle %= 2*Math.PI;
  }
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

function checkHit(){
  let inZone=false;
  if(zoneStart<zoneEnd) inZone=(angle>=zoneStart && angle<=zoneEnd);
  else inZone=(angle>=zoneStart || angle<=zoneEnd);

  if(inZone){
    streak++;
    document.getElementById("combo").textContent=streak;
    if((mode==='normal' && streak>=50) || (mode==='persecution' && streak>=50)){
      phase="clear";
      document.getElementById("combo").textContent="";
      alert("„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ50ÂõûÈÅîÊàê„Å†„ÇàÔºÅ");
      return;
    }
    randZone();
  } else {
    miss();
  }
}

function miss(){
  phase="explosion";
  showInitialNeedle=false;
  document.getElementById("combo").textContent="";
  const ex=document.getElementById("explosion");
  ex.style.display="block";
  ex.currentTime=0;
  ex.play();
  ex.onended=()=>{
    ex.style.display="none";
    phase="idle";
    streak=0;
    document.getElementById("combo").textContent="";
    document.getElementById("welcome").style.display="block";
    showInitialNeedle=true;
  }
}

let mode="normal";
function startGame(which){
  mode=which;
  currentZoneRatio=(mode==="persecution"?CONFIG.PERSECUTE_ZONE:CONFIG.NORMAL_ZONE);
  document.getElementById("welcome").style.display="none";
  document.getElementById("combo").textContent="";
  showInitialNeedle=false;   // ‚Üê „Çπ„Çø„Éº„ÉàÊôÇ„Å´ÂàùÊúüÈáù„ÇíÊ∂à„Åô
  streak=0;
  setupInitial();
  phase="play";
}

document.getElementById("tapBtn").onclick=()=>{
  if(phase==="play") checkHit();
};
document.getElementById("startBtn").onclick=()=>{
  startGame("normal");
};
document.getElementById("persecutionBtn").onclick=()=>{
  startGame("persecution");
};

</script>
</body>
</html>
