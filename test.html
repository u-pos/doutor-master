<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>æ€’æ¶›ã®åµãƒã‚¹ã‚¿ãƒ¼ãƒ»ã‚¶ãƒ»ã‚²ãƒ¼ãƒ </title>
<style>
  :root{ --bg:#0f1115; --fg:#eaeef2; }
  html,body{
    margin:0;height:100%;
    background:var(--bg);color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    overscroll-behavior:none;touch-action:none;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;
  }
  header.title{width:100%;display:flex;justify-content:center;align-items:center;
    padding:8px 6px;margin:0;background:#0b1220;border-bottom:1px solid #1f2b3a}
  header.title h1{margin:0;font-size:clamp(18px,4.3vw,24px);font-weight:900;color:#9bd5ff}

  /* ç¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æœ€å¾Œã®è¡Œã‚’èµ¤ã§ */
  .overlay .unlock-red{ color:#ff4d4d !important; }

  .wrap{min-height:calc(100dvh - 48px);display:flex;flex-direction:column;align-items:center;gap:4px;padding:4px 6px 2px}

  .board{width:100%;max-width:720px;position:relative}
  #cv{width:100%;height:100%;display:block;background:#0b0e13;border-radius:12px}

  /* ãƒŸãƒ¥ãƒ¼ãƒˆï¼ˆå††ã®å·¦ä¸Šå›ºå®šï¼‰ */
  #muteBtn{
    position:absolute;top:6px;left:6px;z-index:5;
    width:40px;height:40px;font-size:20px;line-height:1;text-align:center;
    border-radius:8px;border:1px solid #26303a;background:#1f2937;color:#eaeef2;cursor:pointer;
  }

  .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:3;font-weight:900;
    font-size:clamp(26px,7.5vw,52px);background:rgba(0,0,0,.25);backdrop-filter:saturate(120%) blur(1px);text-align:center}
  .overlay.show{display:flex}
  .overlay .ovtxt{display:inline-block;color:yellow;line-height:1}

  .welcome{position:absolute;inset:0;display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center;z-index:2;
    text-align:center;background:rgba(0,0,0,.25)}
  .welcome h2{margin:0;font-size:clamp(26px,8vw,46px);font-weight:900;color:#c8ffe0;}

  .tap-row{width:100%;max-width:820px;margin-top:2px;display:flex;justify-content:center}
  #tapBtn{
    width:min(92%,620px);height:92px;margin-bottom:10px;
    border:2px solid #334155;border-radius:16px;background:#0f131a;
    font-weight:900;font-size:clamp(20px,6vw,30px);color:#e5e7eb;cursor:pointer;-webkit-tap-highlight-color:transparent;
  }
  #tapBtn[disabled]{opacity:.45;cursor:not-allowed}

  .bar, #doctorWrap{
    width:min(92%,620px);
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:8px;
    justify-content:center;
    align-items:stretch;
  }
  .btn{
    border:1px solid #26303a;background:#1f2937;color:#fff;border-radius:12px;
    padding:10px 12px;
    font-weight:900;font-size:clamp(18px,5vw,24px);
    cursor:pointer;width:100%;
  }
  #startBtn{background:#10b981;border-color:#065f46;color:#062e26}

  /* ãƒ‰ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼ˆè§£æ”¾å¾Œã«è¡¨ç¤ºï¼‰ */
  #doctorBtn{display:none;background:#0ea5e9;color:#06202b;border-radius:12px;padding:10px 12px}
  #rankDocBtn{display:none}
  
  dialog{border:none;border-radius:12px;padding:0;max-width:520px;width:90vw;background:#0f111a;color:#fff}
  .dlg-head{padding:12px 14px;border-bottom:1px solid #253040;font-weight:700}
  .rank-list{width:100%;border-collapse:collapse}
  .rank-list th,.rank-list td{padding:8px 6px;border-bottom:1px solid #1d2533;text-align:left}
</style>
</head>
<body>
  <header class="title" id="hdr"><h1>æ€’æ¶›ã®åµãƒã‚¹ã‚¿ãƒ¼ãƒ»ã‚¶ãƒ»ã‚²ãƒ¼ãƒ </h1></header>

  <div class="wrap">
    <div class="board" id="board">
      <canvas id="cv"></canvas>
      <button id="muteBtn" aria-label="ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡æ›¿">ğŸ”Š</button>
      <div id="welcome" class="welcome"><h2 id="welcomeText">ç›®æŒ‡ã› 50é€£ç¶šï¼</h2></div>
      <div id="overlay" class="overlay"><div class="ovtxt"></div></div>
    </div>

    <div class="tap-row" id="tapRow"><button id="tapBtn" disabled>TAP</button></div>

    <div class="bar" id="btnBar">
      <button id="startBtn" class="btn">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <button id="rankNormalBtn" class="btn">ğŸ† é€šå¸¸</button>
    </div>

    <div id="doctorWrap">
      <button id="doctorBtn" class="btn">ãƒ‰ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰</button>
      <button id="rankDocBtn" class="btn">ğŸ† ãƒ‰ã‚¯ã‚¿ãƒ¼</button>
    </div>
  </div>

  <dialog id="rankDlg">
    <div class="dlg-head" id="rankTitle">ğŸ† è‡ªå·±ãƒ©ãƒ³ã‚­ãƒ³ã‚°TOP5ï¼ˆé€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼‰</div>
    <div class="dlg-body">
      <table class="rank-list"><thead><tr><th>#</th><th>æ—¥ä»˜</th><th>é€£ç¶šå›æ•°</th></tr></thead><tbody id="rankTbody"></tbody></table>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin:10px 14px 14px"><button id="closeRank" class="btn">é–‰ã˜ã‚‹</button></div>
    </div>
  </dialog>

<script>
(() => {
  // ===== è¨­å®š =====
  const CONFIG = {
    RPM: 60,
    INPUT_CD_MS: 45,
    NEXT_MIN_DEG: 180,
    NEXT_MAX_DEG: 220,
    COUNTDOWN_MS: 1500,
    TARGET_STREAK: 50,

    // æˆåŠŸã‚¾ãƒ¼ãƒ³ï¼ˆè§’å¹…ã®æ¯”ç‡ï¼‰â†ã€Œå‰ã®åºƒã•ã€ã«æˆ»ã™
    NORMAL_ZONE: 0.10,

    // ãƒ©ã‚°æ•‘æ¸ˆï¼ˆãŠã¾ã‘ï¼‰1åº¦
    HIT_EPSILON_DEG: 1,

    // è¦‹ãŸç›®ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆå††/é‡/ã‚¾ãƒ¼ãƒ³å¤ªã•ã‚’0.6å€ï¼‰â€»å…ƒã‚³ãƒ¼ãƒ‰æº–æ‹ 
    DRAW_SCALE: 0.6
  };

  // ===== è¦ç´  =====
  const $=id=>document.getElementById(id);
  const hdr=$('hdr'), board=$('board'), cv=$('cv'), ctx=cv.getContext('2d',{alpha:false,desynchronized:true});
  const tapRow=$('tapRow'), btnBar=$('btnBar'), doctorWrap=$('doctorWrap');
  const tapBtn=$('tapBtn'), startBtn=$('startBtn'), doctorBtn=$('doctorBtn');
  const rankNormalBtn=$('rankNormalBtn'), rankDocBtn=$('rankDocBtn');
  const muteBtn=$('muteBtn'), overlay=$('overlay'), welcome=$('welcome'), welcomeText=$('welcomeText');
  const rankDlg=$('rankDlg'), rankTbody=$('rankTbody'), rankTitle=$('rankTitle'), closeRank=$('closeRank');

  // ===== çŠ¶æ…‹ =====
  let phase='idle', streak=0, lastInputAt=0, rafId=0, isMuted=false;
  let mode='normal', currentZoneRatio=CONFIG.NORMAL_ZONE;
  const FULL=Math.PI*2;
  const zoneSize=()=>FULL*currentZoneRatio;
  let baseAngle=0, baseTime=0, frozenAngle=0, zoneStart=0;
  let lastAngle=null, lastInside=false;
  let showNeedle=false;

  // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨˜éŒ²
  let cssW=0, cssH=0, dpr=1;
  let lastRadius=0, lastZoneLineWidth=24*CONFIG.DRAW_SCALE;

  // ä¸­å¿ƒåº§æ¨™ï¼ˆé€šå¸¸ã¯ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸­å¤®ã€ãƒ‰ã‚¯ã‚¿ãƒ¼ã§æˆåŠŸæ¯ã«å®‰å…¨ãƒ©ãƒ³ãƒ€ãƒ ç§»å‹•ï¼‰
  let centerX = 0;
  let centerY = 0;

  // ===== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ =====
  function visualH(){ return (window.visualViewport?.height) || window.innerHeight; }
  function fitBoardToViewport(){
    const vh=visualH(), headH=hdr.offsetHeight, tapH=tapRow.offsetHeight, barH=btnBar.offsetHeight;
    const docH=(doctorWrap.offsetHeight||0) * ((doctorBtn.style.display!=='none'||rankDocBtn.style.display!=='none')?1:0);
    const reserve=headH+tapH+barH+docH+12;
    const idealSide=Math.min(board.clientWidth||board.getBoundingClientRect().width||320, Math.max(160, vh-reserve));
    board.style.height=idealSide+'px';
  }
  function resizeCanvas(){
    fitBoardToViewport();
    const rect=cv.getBoundingClientRect();
    dpr=Math.max(1, Math.min(3, window.devicePixelRatio||1));
    cssW=rect.width||300; cssH=rect.height||300;
    cv.width=Math.round(cssW*dpr); cv.height=Math.round(cssH*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    // ãƒªã‚µã‚¤ã‚ºæ™‚ã¯ã„ã£ãŸã‚“ä¸­å¤®ã¸ï¼ˆæ¬¡ã®æˆåŠŸã§ã¾ãŸå‹•ãï¼‰
    centerX = cssW/2; centerY = cssH/2;
    draw(getCurrentAngle(performance.now()));
    placeWelcomeBetweenCircleAndTap(); // ã‚¦ã‚§ãƒ«ã‚«ãƒ ã‚’å††ã¨TAPã®é–“ã¸
  }
  window.addEventListener('resize', resizeCanvas);
  window.addEventListener('orientationchange', resizeCanvas);
  window.visualViewport?.addEventListener('resize', resizeCanvas);
  requestAnimationFrame(resizeCanvas);

  // ===== ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«/ã‚¸ã‚§ã‚¹ãƒãƒ£æŠ‘æ­¢ =====
  document.addEventListener('touchmove',(e)=>e.preventDefault(),{passive:false});
  ['gesturestart','gesturechange','gestureend','dblclick'].forEach(ev=>document.addEventListener(ev,(e)=>e.preventDefault(),{passive:false}));

  // ===== ã‚µã‚¦ãƒ³ãƒ‰ =====
  const AudioCtx=window.AudioContext||window.webkitAudioContext;
  let actx=null,gMaster=null;
  const buf={success:null,bomb:null,ready:null,fanfare:null};
  const html={};['success','bomb','ready','fanfare'].forEach(k=>{const a=new Audio(`${k}.mp3`);a.preload='auto';a.playsInline=true;html[k]=a;});
  async function unlockAndWarmAudio(){
    try{
      if(!actx){ actx=new AudioCtx({latencyHint:'interactive'}); gMaster=actx.createGain(); gMaster.gain.value=isMuted?0:1; gMaster.connect(actx.destination);}
      if(actx.state==='suspended') await actx.resume();
      await Promise.all(Object.keys(buf).map(async k=>{ if(buf[k]) return; const res=await fetch(`${k}.mp3`); const ab=await res.arrayBuffer(); buf[k]=await actx.decodeAudioData(ab); }));
    }catch{}
  }
  function setMuted(m){ isMuted=m; if(gMaster) gMaster.gain.value=m?0:1; Object.values(html).forEach(a=>a.muted=m); muteBtn.textContent=m?'ğŸ”‡':'ğŸ”Š'; }
  function playBuf(key,gain=0.95){ try{ if(!actx||!buf[key]) return false; const src=actx.createBufferSource(); const g=actx.createGain(); g.gain.value=gain; src.buffer=buf[key]; src.connect(g).connect(gMaster||actx.destination); src.start(); return true;}catch{return false} }
  function playSE(key){ if(isMuted) return; if(playBuf(key)) return; unlockAndWarmAudio(); const tag=html[key]; if(tag){ try{ tag.currentTime=0; tag.play(); }catch{} } }
  window.addEventListener('pointerdown', ()=>{ unlockAndWarmAudio(); }, {once:true});

  // ===== è§’åº¦/æç”» =====
  const norm=a=>(a%FULL+FULL)%FULL;
  const inRange=(a,s,e)=>(s<=e)?(a>=s&&a<=e):(a>=s||a<=e);
  const cwDelta=(f,t)=>(t-f+FULL)%FULL;
  const angleAt=t=>{ const rps=CONFIG.RPM/60; const d=(t-baseTime)/1000; return norm(baseAngle + rps*FULL*d); };
  const getCurrentAngle=t=>(phase==='play')?angleAt(t):frozenAngle;

  function draw(angle){
    const w=cssW,h=cssH,CX=centerX,CY=centerY;
    const r = Math.min(w,h)*0.42*CONFIG.DRAW_SCALE;     // åŠå¾„0.6å€ï¼ˆæ—¢å­˜ä»•æ§˜ï¼‰
    const zoneLine = 24*CONFIG.DRAW_SCALE;              // ã‚¾ãƒ¼ãƒ³å¤ªã•
    const needleW  = 6*CONFIG.DRAW_SCALE;               // é‡å¤ªã•
    const needleLenRatio = 1.2;                         // æ—¢å­˜æç”»ã®é‡é•·ï¼ˆå¤–å‘¨ã‚ˆã‚Šå°‘ã—é•·ã„ï¼‰
    const ZS=zoneSize();

    lastRadius = r;
    lastZoneLineWidth = zoneLine;

    ctx.clearRect(0,0,w,h);

    // å¤–æ 
    ctx.beginPath(); ctx.arc(CX,CY,r,0,FULL); ctx.lineWidth=2; ctx.strokeStyle='#1a2330'; ctx.stroke();

    // æˆåŠŸã‚¾ãƒ¼ãƒ³ï¼ˆç™½ï¼‰
    ctx.beginPath();
    ctx.lineWidth=zoneLine; ctx.strokeStyle='#ffffff';
    ctx.arc(CX,CY,r,zoneStart,zoneStart+ZS); ctx.stroke();

    // é‡
    if(showNeedle){
      const fx=CX+(r*needleLenRatio)*Math.cos(angle), fy=CY+(r*needleLenRatio)*Math.sin(angle);
      ctx.beginPath(); ctx.moveTo(CX,CY); ctx.lineTo(fx,fy);
      ctx.lineWidth=needleW; ctx.lineCap='butt'; ctx.strokeStyle='#ef4444'; ctx.stroke();
    }

    // ã‚³ãƒ³ãƒœ
    const combo=String(streak);
    ctx.save(); ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font=`900 ${Math.max(18,Math.round(r*0.32))}px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif`;
    ctx.lineWidth=Math.max(2,Math.round(r*0.04)); ctx.strokeStyle='rgba(0,0,0,0.55)'; ctx.strokeText(combo,CX,CY-r*0.18);
    ctx.fillStyle='#eaeef2'; ctx.fillText(combo,CX,CY-r*0.18); ctx.restore();
  }

  // ===== ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ã‚¦ã‚§ãƒ«ã‚«ãƒ ã®ä½ç½®ï¼ˆå††ã¨TAPã®é–“ï¼‰ =====
  function placeOverlayBelowCircle(ov){
    const margin = 22;
    const dy = (lastRadius + (lastZoneLineWidth/2) + margin);
    ov.style.transform = `translateY(${dy}px)`;
  }
  function placeWelcomeBetweenCircleAndTap(){
    const margin = 22;
    const dy = (lastRadius + (lastZoneLineWidth/2) + margin);
    welcomeText.style.transform = `translateY(${dy}px)`;
  }

  // ===== ãƒ«ãƒ¼ãƒ— =====
  function loop(now){
    const ang=getCurrentAngle(now);
    draw(ang);
    if(phase==='play'){
      const ZS=zoneSize(), end=norm(zoneStart+ZS);
      const inside=inRange(ang,zoneStart,end);
      if(lastAngle!==null && lastInside && !inside){
        const moved=cwDelta(lastAngle,ang), toEnd=cwDelta(lastAngle,end);
        if(moved>=toEnd){ return gameOver(); }
      }
      lastInside=inside; lastAngle=ang;
    }
    rafId=requestAnimationFrame(loop);
  }

  // ===== åˆ¤å®š =====
  function tapTimestamp(e){
    const ts=(e&&typeof e.timeStamp==='number')?e.timeStamp:performance.now();
    return (Math.abs(ts - performance.now()) < 10000) ? ts : performance.now();
  }

  // ===== å®‰å…¨ãƒ©ãƒ³ãƒ€ãƒ ä¸­å¿ƒï¼ˆãƒ‰ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰ =====
  function relocateCenterSafely(){
    // CSSãƒ”ã‚¯ã‚»ãƒ«åº§æ¨™ç³»ï¼ˆæç”»ã¯CTXã‚’dprã§æ‹¡ç¸®ã—ã¦ã„ã‚‹ãŸã‚CSSåŸºæº–ã§OKï¼‰
    const w = cssW, h = cssH;
    const r = Math.min(w,h)*0.42*CONFIG.DRAW_SCALE;
    const zoneLine = 24*CONFIG.DRAW_SCALE;
    const needleW  = 6*CONFIG.DRAW_SCALE;
    const needleLenRatio = 1.2; // é‡ã¯å¤–å‘¨ã‚ˆã‚Šå°‘ã—é•·ã„

    // ã¯ã¿å‡ºã—é˜²æ­¢ãƒãƒ¼ã‚¸ãƒ³ï¼šé‡å…ˆãŒç›¤å¤–ã«å‡ºãªã„æœ€å¤§é•·ï¼‹ä½™ç™½
    const M = (r*needleLenRatio) + Math.max(zoneLine/2, needleW/2) + 2;

    const minX = M, maxX = w - M;
    const minY = M, maxY = h - M;

    if (minX > maxX || minY > maxY){
      centerX = w/2; centerY = h/2; return;
    }
    centerX = Math.round(minX + Math.random()*(maxX - minX));
    centerY = Math.round(minY + Math.random()*(maxY - minY));
  }

  // ===== ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ =====
  function setupInitial(){
    const center=Math.random()*FULL, ZS=zoneSize();
    zoneStart = norm(center - ZS/2);
    frozenAngle = norm(center + Math.PI);
    lastInside=false; lastAngle=null;

    // åˆæœŸä¸­å¿ƒã¯ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸­å¤®
    centerX = cssW/2; centerY = cssH/2;

    resizeCanvas();
  }
  function moveZoneAfterSuccess(a){
    const min=CONFIG.NEXT_MIN_DEG*Math.PI/180, max=CONFIG.NEXT_MAX_DEG*Math.PI/180;
    const nextCenter=norm(a + (min + Math.random()*(max-min)));
    const ZS=zoneSize();
    zoneStart=norm(nextCenter - ZS/2);
    lastInside=false; lastAngle=null;

    // â˜… ãƒ‰ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰æ™‚ï¼šæˆåŠŸã®ãŸã³ã«ä¸­å¿ƒã‚’å®‰å…¨ãƒ©ãƒ³ãƒ€ãƒ ç§»å‹•
    if (mode === 'doctor') {
      relocateCenterSafely();
    }
  }

  function onTap(e){
    if(phase!=='play') return;
    const now=tapTimestamp(e);
    if(now-lastInputAt<CONFIG.INPUT_CD_MS) return;
    lastInputAt=now;

    const a=angleAt(now), ZS=zoneSize(), end=norm(zoneStart+ZS);
    const EPS=CONFIG.HIT_EPSILON_DEG*Math.PI/180;
    const ok = inRange(a, zoneStart, end) || cwDelta(end, a) <= EPS;

    if(ok){
      playSE('success');
      streak++;

      // â˜… 50åˆ°é”æ™‚ã¯ç¶™ç¶šã€‚ãŠç¥ã„ã¯ãƒŸã‚¹æ™‚ã«å‡ºã™ï¼ˆæ—¢å­˜æ–¹é‡ï¼‰
      baseAngle=a; baseTime=now;
      moveZoneAfterSuccess(a);
      draw(a);
    }else{
      gameOver();
    }
  }

  // Ready/GO ã‚’å††ã¨TAPã®é–“ã«è¡¨ç¤º
  function showCountdown(){
    overlay.classList.add('show');
    const el = overlay.querySelector('.ovtxt');
    el.style.color = 'yellow';
    el.textContent = 'Ready';
    placeOverlayBelowCircle(el);

    tapBtn.disabled=true; phase='countdown';
    showNeedle=false; draw(frozenAngle);

    const t0=performance.now(), mid=t0+CONFIG.COUNTDOWN_MS*0.6, end=t0+CONFIG.COUNTDOWN_MS;
    const tick=()=>{
      const now=performance.now();
      if(now>=end){
        overlay.classList.remove('show');
        el.textContent='';
        baseAngle=frozenAngle; baseTime=now;
        phase='play'; tapBtn.disabled=false;
        showNeedle=true;
        const ang=angleAt(now), ZS=zoneSize();
        lastAngle=ang; lastInside=inRange(ang, zoneStart, norm(zoneStart+ZS));
        return;
      }
      if(now>=mid){
        el.textContent='GO!';
        placeOverlayBelowCircle(el);
      }
      requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);
  }

  function startGame(which){
    mode=which;
    // â˜… ãƒ‰ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ã‚¾ãƒ¼ãƒ³å¹…ã¯é€šå¸¸ã¨åŒã˜
    currentZoneRatio = CONFIG.NORMAL_ZONE;

    welcome.style.display='none';
    playSE('ready'); unlockAndWarmAudio();
    if(rafId) cancelAnimationFrame(rafId);
    streak=0;
    showNeedle=false;
    setupInitial();
    showCountdown();
    rafId=requestAnimationFrame(loop);
  }

  // ===== ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼ˆã“ã“ã§ç¥æ¼”å‡ºã‚’æ¡ä»¶åˆ†å²ï¼‰ =====
  function gameOver(){
    stopGame(true);
    saveScore({score:streak, at:Date.now()});
    updateUnlockVisibility();

    const el = overlay.querySelector('.ovtxt');

    if(streak >= CONFIG.TARGET_STREAK && mode==='normal'){
      // â˜… é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§50å›ä»¥ä¸Šç¶™ç¶šâ†’ãƒŸã‚¹æ™‚ã«è§£æ”¾å‘ŠçŸ¥ï¼†SE
      el.innerHTML =
        '<span style="color:#ffffff">50å›é”æˆãŠã‚ã§ã¨ã†ğŸ‰</span><br>' +
        '<span class="unlock-red">ãƒ‰ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰ãŒã‚¢ãƒ³ãƒ­ãƒƒã‚¯ï¼</span>';
      overlay.classList.add('show');
      placeOverlayBelowCircle(el);

      playSE('fanfare');
      try{ localStorage.setItem('skillcheck_unlock_doctor','1'); }catch{}
      updateUnlockVisibility();
    }else{
      // é€šå¸¸ã®GAMEOVERï¼ˆç™½æ–‡å­—ï¼‰
      el.style.color = '#ffffff';
      el.textContent = 'GAMEOVER';
      overlay.classList.add('show');
      placeOverlayBelowCircle(el);
      playSE('bomb');
    }
  }

  function stopGame(keepOverlay){
    phase='idle'; tapBtn.disabled=true;
    showNeedle=false;
    if(rafId) cancelAnimationFrame(rafId);
    if(!keepOverlay){
      overlay.classList.remove('show');
      overlay.querySelector('.ovtxt').textContent='';
    }
    draw(frozenAngle);
  }

  // ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚° =====
  const KEY_NORMAL='rank_normal_v2';
  const KEY_DOC   ='rank_doc_v1';
  function loadScores(key){ try{ return JSON.parse(localStorage.getItem(key)||'[]'); }catch{return []} }
  function saveScore(entry){
    const key=(mode==='doctor')?KEY_DOC:KEY_NORMAL;
    if(entry.score<=0) return;
    const arr=loadScores(key); arr.push(entry);
    arr.sort((a,b)=> b.score-a.score || b.at-a.at);
    localStorage.setItem(key, JSON.stringify(arr.slice(0,5)));
  }
  function openRanking(which){
    const key=(which==='doctor')?KEY_DOC:KEY_NORMAL;
    const arr=loadScores(key);
    rankTbody.innerHTML='';
    arr.forEach((e,i)=>{
      const d=new Date(e.at);
      const date=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate())}`;
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${date}</td><td>${e.score}</td>`;
      rankTbody.appendChild(tr);
    });
    rankTitle.textContent=(which==='doctor')?'ğŸ† è‡ªå·±ãƒ©ãƒ³ã‚­ãƒ³ã‚°TOP5ï¼ˆãƒ‰ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼‰':'ğŸ† è‡ªå·±ãƒ©ãƒ³ã‚­ãƒ³ã‚°TOP5ï¼ˆé€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼‰';
    rankDlg.showModal();
  }

  // ===== ãƒœã‚¿ãƒ³å¯è¦–åˆ¶å¾¡ =====
  function isUnlocked(){ try{ return localStorage.getItem('skillcheck_unlock_doctor')==='1'; }catch{ return false; } }
  function updateUnlockVisibility(){
    const unlocked=isUnlocked();
    doctorBtn.style.display = unlocked ? 'inline-block' : 'none';
    rankDocBtn.style.display = unlocked ? 'inline-block' : 'none';
    requestAnimationFrame(resizeCanvas);
  }

  // ===== ã‚¤ãƒ™ãƒ³ãƒˆ =====
  startBtn   .addEventListener('click', e=>{ e.preventDefault(); startGame('normal'); }, {passive:false});
  doctorBtn  .addEventListener('click', e=>{ e.preventDefault(); startGame('doctor'); }, {passive:false});
  tapBtn     .addEventListener('pointerdown', e=>{ e.preventDefault(); onTap(e); }, {passive:false});
  window.addEventListener('keydown', e=>{ if(e.code==='Space'){ e.preventDefault(); onTap(e); } });

  muteBtn.addEventListener('click', e=>{ e.preventDefault(); setMuted(!isMuted); }, {passive:false});
  rankNormalBtn.addEventListener('click', e=>{ e.preventDefault(); openRanking('normal'); }, {passive:false});
  rankDocBtn   .addEventListener('click', e=>{ e.preventDefault(); openRanking('doctor'); }, {passive:false});
  closeRank    .addEventListener('click', e=>{ e.preventDefault(); rankDlg.close(); }, {passive:false});

  // ===== åˆæœŸåŒ– =====
  setMuted(false);
  updateUnlockVisibility();
  requestAnimationFrame(()=>{ resizeCanvas(); });
})();
</script>
</body>
</html>
